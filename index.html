<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>539 è¨ˆé‡æ±ºç­–å¼•æ“ V8.0 - ç©©å¥æ€§å£“åŠ›æ¸¬è©¦ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --bg: #0d1117; --p: #161b22; --acc: #58a6ff; --err: #f85149; --win: #238636; }
        body { font-family: 'JetBrains Mono', 'Fira Code', monospace; background: var(--bg); color: #c9d1d9; font-size: 11px; padding: 15px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 12px; }
        .card { background: var(--p); border: 1px solid #30363d; border-radius: 8px; padding: 16px; margin-bottom: 12px; }
        .ball { display: inline-block; width: 34px; height: 34px; line-height: 34px; background: linear-gradient(135deg, #238636, #2ea043); border-radius: 50%; text-align: center; margin: 3px; font-weight: bold; }
        .metric { font-size: 18px; color: var(--acc); font-weight: bold; font-family: 'Consolas'; }
        #log { height: 100px; overflow-y: auto; background: #010409; padding: 8px; color: #7ee787; border: 1px solid #30363d; }
        button { background: #21262d; color: white; border: 1px solid #30363d; padding: 12px; border-radius: 6px; cursor: pointer; width: 100%; font-weight: bold; }
        .status-tag { padding: 3px 8px; border-radius: 4px; font-size: 10px; font-weight: bold; }
        .tag-active { background: #1c3e24; color: #3fb950; }
        .tag-fail { background: #3e1c1c; color: var(--err); }
    </style>
</head>
<body>

<div class="card">
    <h3 style="margin:0 0 10px 0;">ğŸ›¡ï¸ 539 é‡åŒ–å¼•æ“ V8.0 - å¯¦è­‰åˆ†ä½ˆèˆ‡ç©©å¥æ€§å£“åŠ›æ¸¬è©¦</h3>
    <input type="file" id="csvFile" style="margin-bottom:10px; width: 100%;">
    <button onclick="EngineV8.init()">åŸ·è¡Œå…¨ç¶­åº¦è­‰å½å›æ¸¬</button>
</div>

<div class="grid">
    <div class="card">
        <strong>å¯¦è­‰è¨ˆé‡æŒ‡æ¨™ (Empirical Metrics)</strong>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;">
            <div>Empirical P-Value<br><span id="pVal" class="metric">--</span></div>
            <div>Risk-Adj Alpha<br><span id="alpha" class="metric">--</span></div>
            <div>Real Sharpe Ratio<br><span id="sharpe" class="metric">--</span></div>
            <div>Robustness Score<br><span id="score" class="metric">--</span></div>
        </div>
    </div>
    
    <div class="card">
        <strong>æ±ºç­–æ±  (Portfolio) & ä¿¡å¿ƒå€é–“</strong>
        <div id="portfolio" style="margin: 10px 0;"></div>
        <div id="status">ç‹€æ…‹ï¼š<span id="sigStatus" class="status-tag">IDLE</span></div>
    </div>
</div>

<div class="grid">
    <div class="card">
        <strong>å›æ¸¬ç´¯è¨ˆæœŸæœ›å€¼ (Expected Value Curve)</strong>
        <canvas id="evChart" height="130"></canvas>
    </div>
    <div class="card">
        <strong>è™›ç„¡åˆ†ä½ˆæª¢å®š (Permutation Test)</strong>
        <canvas id="nullDistChart" height="130"></canvas>
    </div>
</div>

<div id="log">ç³»çµ±å°±ç·’ã€‚ç­‰å¾…æ•¸æ“šè¼¸å…¥ä»¥åŸ·è¡Œå£“åŠ›æ¸¬è©¦...</div>

<script>
// V8.0 æ ¸å¿ƒå¼•æ“ï¼šæ¨¡çµ„åŒ–è¨­è¨ˆ
const EngineV8 = {
    config: { seed: 42, mc_trials: 1000, test_win: 100, reward: { 2: 1, 3: 10, 4: 100, 5: 1000 } },
    
    // 1. ç‰¹å¾µæå– (å¸¶æœ‰å‹•æ…‹æ¬Šé‡æ ¡æº–)
    extract: (data, decay = 0.998) => {
        let freq = new Array(40).fill(0), gaps = new Array(40).fill(0);
        data.forEach((d, i) => {
            const w = Math.pow(decay, data.length - i);
            d.forEach(n => { freq[n] += w; gaps[n] = data.length - i; });
        });
        return { freq, gaps, t: data.length };
    },

    // 2. æ¼”åŒ–å°‹å„ª (GA + çµæ§‹ç´„æŸ)
    evolve: (f) => {
        const fitness = (s) => {
            let score = s.reduce((a, n) => a + f.freq[n], 0);
            const gapBonus = s.reduce((a, n) => a + Math.log1p(f.t - f.gaps[n]), 0) * 0.4;
            // æ–½åŠ çµæ§‹ç´„æŸ (é¿å…æ¥µç«¯åˆ†ä½ˆ)
            const zones = [0,0,0]; s.forEach(n => zones[Math.floor((n-1)/13)]++);
            const penalty = zones.some(z => z > 3) ? 0.7 : 1.0;
            return (score + gapBonus) * penalty;
        };
        let pop = Array.from({length: 40}, () => EngineV8.randSet());
        for(let g=0; g<60; g++) {
            pop.sort((a,b) => fitness(b) - fitness(a));
            for(let i=20; i<40; i++) pop[i] = EngineV8.mutate(pop[i-20]);
        }
        return pop[0].sort((a,b)=>a-b);
    },

    randSet: () => {
        let s = new Set(); while(s.size < 5) s.add(Math.floor(Math.random()*39)+1);
        return Array.from(s);
    },

    mutate: (set) => {
        let n = [...set]; n[Math.floor(Math.random()*5)] = Math.floor(Math.random()*39)+1;
        let res = Array.from(new Set(n));
        return res.length === 5 ? res : EngineV8.randSet();
    },

    // 3. å¯¦è­‰å›æ¸¬é‚è¼¯
    init: async () => {
        const file = document.getElementById('csvFile').files[0];
        if (!file) return alert("è«‹è¼‰å…¥æ•¸æ“š");
        const data = (await file.text()).trim().split('\n').map(r => r.split(',')).filter(r => r.length >= 6).map(r => r.slice(1,6).map(Number));
        EngineV8.run(data);
    },

    run: (data) => {
        const log = (m) => { document.getElementById('log').innerHTML += `> ${m}<br>`; };
        log("å•Ÿå‹• V8.0 ç©©å¥æ€§å£“åŠ›æ¸¬è©¦...");

        let modelEV = [], nullEVDist = [];
        const win = EngineV8.config.test_win;

        // Walk-forward æ ¸å¿ƒ
        for (let i = data.length - win; i < data.length; i++) {
            const train = data.slice(0, i);
            const f = EngineV8.extract(train);
            const pred = EngineV8.evolve(f);
            
            const hits = pred.filter(n => data[i].includes(n)).length;
            modelEV.push(EngineV8.config.reward[hits] || 0);

            // æ¯æœŸåŒæ­¥åŸ·è¡Œ 10 æ¬¡ Monte Carlo ä½œç‚ºç¶“é©—è™šç„¡æ¨£æœ¬ (Empirical Baseline)
            for(let j=0; j<10; j++) {
                const rs = EngineV8.randSet(); // é€™è£¡å¯é€²éšåŠ å…¥çµæ§‹ç´„æŸ
                const rh = rs.filter(n => data[i].includes(n)).length;
                nullEVDist.push(EngineV8.config.reward[rh] || 0);
            }
        }

        // 4. è¨ˆé‡çµ±è¨ˆè¨ˆç®—
        const mMean = modelEV.reduce((a,b)=>a+b, 0) / win;
        const nMean = nullEVDist.reduce((a,b)=>a+b, 0) / nullEVDist.length;
        const alpha = mMean - nMean;
        
        // çœŸå¯¦ Sharpe (åŸºæ–¼æ”¶ç›Šæ³¢å‹•)
        const std = Math.sqrt(modelEV.reduce((a,b)=>a+Math.pow(b-mMean,2),0)/win);
        const sharpe = std === 0 ? 0 : (alpha / std).toFixed(3);

        // Empirical P-Value (ç½®æ›æª¢å®šæ¨¡æ“¬)
        const pVal = EngineV8.permTest(modelEV.reduce((a,b)=>a+b,0), nullEVDist, win);

        EngineV8.updateUI(mMean, alpha, sharpe, pVal, modelEV, data);
    },

    permTest: (obsSum, dist, n) => {
        let trials = [];
        for(let i=0; i<1000; i++) {
            let s = 0; for(let j=0; j<n; j++) s += dist[Math.floor(Math.random()*dist.length)];
            trials.push(s);
        }
        return trials.filter(t => t >= obsSum).length / 1000;
    },

    updateUI: (m, a, sharpe, p, evHist, data) => {
        document.getElementById('pVal').innerText = p.toFixed(4);
        document.getElementById('alpha').innerText = a.toFixed(2);
        document.getElementById('sharpe').innerText = sharpe;
        const score = (a * 10 + (1-p) * 50).toFixed(1);
        document.getElementById('score').innerText = score;

        const tag = document.getElementById('sigStatus');
        if (p < 0.05 && a > 0) {
            tag.innerText = "SIGNIFICANT / ACTIVE"; tag.className = "status-tag tag-active";
        } else {
            tag.innerText = "WEAK / OVERFITTING RISK"; tag.className = "status-tag tag-fail";
        }

        const f = EngineV8.extract(data);
        const final = EngineV8.evolve(f);
        document.getElementById('portfolio').innerHTML = final.map(n => `<span class="ball">${n}</span>`).join('');
        
        EngineV8.render(evHist);
    },

    render: (hist) => {
        const ctx = document.getElementById('evChart').getContext('2d');
        let acc = 0; const data = hist.map(v => acc += v);
        new Chart(ctx, {
            type: 'line',
            data: { labels: hist.map((_,i)=>i), datasets: [{ label: 'ç´¯è¨ˆæœŸæœ›å€¼æ”¶ç›Š (Cumulative EV)', data: data, borderColor: '#acc' }] },
            options: { plugins: { legend: { display: false } } }
        });
    }
};
</script>
</body>
</html>
