<script>
// å…¨å±€æ•¸æ“šå­˜å„²
let data = [];
let analysisCache = null;

// é»æ“Šæ”¶åˆåŠŸèƒ½
document.getElementById('toggleLogic').addEventListener('click', function() {
  const content = document.getElementById('logicContent');
  content.style.display = (content.style.display === 'none') ? 'block' : 'none';
});

// æ–‡ä»¶åŠ è¼‰
document.getElementById("csvInput").addEventListener("change", function(e) {
  const file = e.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = function(event) {
    try {
      const content = event.target.result.trim();
      const lines = content.split(/\r?\n/);
      
      data = [];
      lines.forEach((line, index) => {
        if (index === 0) return; // è·³éæ¨™é¡Œè¡Œ
        
        const numbers = line.split(',').map(num => parseInt(num.trim())).filter(num => !isNaN(num));
        if (numbers.length >= 5) {
          data.push(numbers.slice(0, 5)); // åªå–å‰5å€‹è™Ÿç¢¼
        }
      });
      
      // é¡¯ç¤ºåŸºæœ¬ä¿¡æ¯
      displayCSVInfo(data);
      
    } catch (error) {
      showStatus('csvInfo', `è§£æéŒ¯èª¤: ${error.message}`, 'error');
    }
  };
  reader.readAsText(file);
});

// é¡¯ç¤ºCSVä¿¡æ¯
function displayCSVInfo(data) {
  const csvInfo = document.getElementById('csvInfo');
  const basicStats = document.getElementById('basicStats');
  
  if (data.length === 0) {
    showStatus('csvInfo', 'æœªæ‰¾åˆ°æœ‰æ•ˆæ•¸æ“š', 'error');
    basicStats.style.display = 'none';
    return;
  }
  
  // è¨ˆç®—çµ±è¨ˆ
  const totalDraws = data.length;
  const allNumbers = data.flat();
  const uniqueNumbers = [...new Set(allNumbers)];
  
  // è¨ˆç®—å¹³å‡å’Œå€¼
  const sums = data.map(draw => draw.reduce((a, b) => a + b, 0));
  const avgSum = Math.round(sums.reduce((a, b) => a + b, 0) / sums.length);
  
  // è¨ˆç®—å¥‡å¶æ¯”ä¾‹
  const oddCount = allNumbers.filter(n => n % 2 === 1).length;
  const evenCount = allNumbers.length - oddCount;
  const oddRatio = Math.round((oddCount / allNumbers.length) * 100);
  
  // æ›´æ–°é¡¯ç¤º
  showStatus('csvInfo', `æˆåŠŸè¼‰å…¥ ${totalDraws} æœŸæ­·å²æ•¸æ“šï¼Œå…± ${uniqueNumbers.length} å€‹ä¸åŒè™Ÿç¢¼`, 'success');
  
  basicStats.innerHTML = `
    <div class="stat-item">
      <div class="stat-label">ç¸½æœŸæ•¸</div>
      <div class="stat-value">${totalDraws}</div>
    </div>
    <div class="stat-item">
      <div class="stat-label">ä½¿ç”¨è™Ÿç¢¼</div>
      <div class="stat-value">${uniqueNumbers.length}</div>
    </div>
    <div class="stat-item">
      <div class="stat-label">å¹³å‡å’Œå€¼</div>
      <div class="stat-value">${avgSum}</div>
    </div>
    <div class="stat-item">
      <div class="stat-label">å¥‡å¶æ¯”</div>
      <div class="stat-value">${oddRatio}% å¥‡</div>
    </div>
  `;
  basicStats.style.display = 'grid';
}

// é‹è¡Œåˆ†æ
function runAnalysis() {
  if (data.length === 0) {
    alert('è«‹å…ˆè¼‰å…¥CSVæ•¸æ“š');
    return;
  }
  
  const loading = document.getElementById('loadingA');
  const panelA = document.getElementById('panelA');
  
  loading.style.display = 'block';
  panelA.style.display = 'none';
  
  // æ¨¡æ“¬åˆ†æå»¶é²
  setTimeout(() => {
    analysisCache = performAnalysis(data);
    displayAnalysisResults(analysisCache);
    
    loading.style.display = 'none';
    panelA.style.display = 'block';
  }, 1500);
}

// åŸ·è¡Œåˆ†æè¨ˆç®—
function performAnalysis(data) {
  const allNumbers = data.flat();
  const totalDraws = data.length;
  
  // è¨ˆç®—æ¯å€‹è™Ÿç¢¼çš„çµ±è¨ˆ
  const numberStats = {};
  const numberRange = Array.from({length: 49}, (_, i) => i + 1); // 1-49
  
  // åˆå§‹åŒ–çµ±è¨ˆå°è±¡
  numberRange.forEach(num => {
    numberStats[num] = {
      frequency: 0,
      lastSeen: null,
      hotness: 0,
      isHot: false,
      isCold: false,
      oddEven: num % 2 === 1 ? 'å¥‡' : 'å¶'
    };
  });
  
  // è¨ˆç®—å‡ºç¾é »ç‡å’Œæœ€å¾Œå‡ºç¾æœŸæ•¸
  data.forEach((draw, drawIndex) => {
    draw.forEach(num => {
      numberStats[num].frequency++;
      numberStats[num].lastSeen = totalDraws - drawIndex - 1;
    });
  });
  
  // è¨ˆç®—ç†±åº¦ï¼ˆæœ€è¿‘100æœŸå‡ºç¾æ¬¡æ•¸ï¼‰
  const recentDraws = Math.min(100, totalDraws);
  const recentData = data.slice(0, recentDraws);
  const recentNumbers = recentData.flat();
  
  numberRange.forEach(num => {
    const recentFreq = recentNumbers.filter(n => n === num).length;
    numberStats[num].hotness = recentFreq;
  });
  
  // ç¢ºå®šç†±è™Ÿå’Œå†·è™Ÿ
  const hotThreshold = Math.max(1, Math.floor(recentDraws * 5 / 49 * 1.5));
  const coldThreshold = Math.max(0, Math.floor(recentDraws * 5 / 49 * 0.5));
  
  Object.keys(numberStats).forEach(num => {
    numberStats[num].isHot = numberStats[num].hotness >= hotThreshold;
    numberStats[num].isCold = numberStats[num].lastSeen > recentDraws * 2;
  });
  
  // è¨ˆç®—å…¶ä»–çµ±è¨ˆ
  const sums = data.map(draw => draw.reduce((a, b) => a + b, 0));
  const avgSum = Math.round(sums.reduce((a, b) => a + b, 0) / sums.length);
  const minSum = Math.min(...sums);
  const maxSum = Math.max(...sums);
  
  const oddCounts = data.map(draw => draw.filter(n => n % 2 === 1).length);
  const avgOdd = Math.round(oddCounts.reduce((a, b) => a + b, 0) / oddCounts.length * 10) / 10;
  
  // è¨ˆç®—æœ€å¸¸å‡ºç¾çš„è™Ÿç¢¼
  const sortedByFreq = Object.entries(numberStats)
    .sort((a, b) => b[1].frequency - a[1].frequency)
    .slice(0, 10);
  
  // è¨ˆç®—æœ€ä¹…æœªå‡ºç¾çš„è™Ÿç¢¼
  const sortedByLastSeen = Object.entries(numberStats)
    .sort((a, b) => b[1].lastSeen - a[1].lastSeen)
    .slice(0, 10);
  
  return {
    numberStats,
    totalDraws,
    recentDraws,
    hotThreshold,
    coldThreshold,
    avgSum,
    minSum,
    maxSum,
    avgOdd,
    topFrequent: sortedByFreq,
    topMissing: sortedByLastSeen
  };
}

// é¡¯ç¤ºåˆ†æçµæœ
function displayAnalysisResults(results) {
  const panelA = document.getElementById('panelA');
  
  // ç†±è™Ÿé¡¯ç¤º
  const hotNumbers = Object.entries(results.numberStats)
    .filter(([num, stat]) => stat.isHot)
    .map(([num]) => parseInt(num));
  
  // å†·è™Ÿé¡¯ç¤º
  const coldNumbers = Object.entries(results.numberStats)
    .filter(([num, stat]) => stat.isCold)
    .map(([num]) => parseInt(num));
  
  // ç”ŸæˆHTML
  panelA.innerHTML = `
    <div class="box">
      <div class="box-title">ğŸ”¥ ç†±é–€è™Ÿç¢¼ (æœ€è¿‘${results.recentDraws}æœŸå‡ºç¾${results.hotThreshold}+æ¬¡)</div>
      <div class="numbers-grid">
        ${hotNumbers.map(num => `
          <div class="number-ball hot">${num}</div>
        `).join('')}
      </div>
    </div>
    
    <div class="box">
      <div class="box-title">â„ï¸ å†·é–€è™Ÿç¢¼ (è¶…é${results.recentDraws * 2}æœŸæœªå‡ºç¾)</div>
      <div class="numbers-grid">
        ${coldNumbers.map(num => `
          <div class="number-ball cold">${num}</div>
        `).join('')}
      </div>
    </div>
    
    <div class="stats-row">
      <div class="stat-item">
        <div class="stat-label">å’Œå€¼ç¯„åœ</div>
        <div class="stat-value">${results.minSum} - ${results.maxSum}</div>
      </div>
      <div class="stat-item">
        <div class="stat-label">å¹³å‡å’Œå€¼</div>
        <div class="stat-value">${results.avgSum}</div>
      </div>
      <div class="stat-item">
        <div class="stat-label">å¹³å‡å¥‡æ•¸</div>
        <div class="stat-value">${results.avgOdd}</div>
      </div>
      <div class="stat-item">
        <div class="stat-label">ç†±è™Ÿæ•¸é‡</div>
        <div class="stat-value">${hotNumbers.length}</div>
      </div>
    </div>
    
    <div class="box">
      <div class="box-title">ğŸ“ˆ æœ€å¸¸å‡ºç¾è™Ÿç¢¼ (å‰10å)</div>
      <div class="numbers-grid">
        ${results.topFrequent.map(([num, stat]) => `
          <div class="number-ball" title="å‡ºç¾${stat.frequency}æ¬¡">${num}</div>
        `).join('')}
      </div>
    </div>
    
    <div class="box">
      <div class="box-title">â³ æœ€ä¹…æœªå‡ºç¾è™Ÿç¢¼ (å‰10å)</div>
      <div class="numbers-grid">
        ${results.topMissing.map(([num, stat]) => `
          <div class="number-ball" title="éºæ¼${stat.lastSeen}æœŸ">${num}</div>
        `).join('')}
      </div>
    </div>
  `;
}

// é‹è¡Œé©—è­‰
function runVerify() {
  const input = document.getElementById('verifyInput').value.trim();
  const panelB = document.getElementById('panelB');
  
  if (!input) {
    alert('è«‹è¼¸å…¥è¦é©—è­‰çš„è™Ÿç¢¼çµ„åˆ');
    return;
  }
  
  // è§£æè¼¸å…¥çš„è™Ÿç¢¼
  const numbers = input.split(/\s+|,/)
    .map(num => parseInt(num))
    .filter(num => !isNaN(num) && num >= 1 && num <= 49);
  
  if (numbers.length < 5) {
    showStatus('panelB', 'è«‹è¼¸å…¥è‡³å°‘5å€‹æœ‰æ•ˆè™Ÿç¢¼(1-49)', 'error');
    return;
  }
  
  if (new Set(numbers).size !== numbers.length) {
    showStatus('panelB', 'è™Ÿç¢¼ä¸èƒ½é‡è¤‡', 'error');
    return;
  }
  
  // é€²è¡Œé©—è­‰åˆ†æ
  const analysis = verifyCombination(numbers);
  displayVerifyResults(analysis, numbers);
  panelB.style.display = 'block';
}

// é©—è­‰çµ„åˆ
function verifyCombination(numbers) {
  if (data.length === 0) {
    return { error: 'è«‹å…ˆè¼‰å…¥æ­·å²æ•¸æ“š' };
  }
  
  // åŸºæœ¬çµ±è¨ˆ
  const sum = numbers.reduce((a, b) => a + b, 0);
  const oddCount = numbers.filter(n => n % 2 === 1).length;
  const evenCount = numbers.length - oddCount;
  const sorted = [...numbers].sort((a, b) => a - b);
  const span = sorted[sorted.length - 1] - sorted[0];
  
  // æª¢æŸ¥æ­·å²å‡ºç¾æƒ…æ³
  let appearedTogether = 0;
  let lastAppeared = null;
  
  data.forEach((draw, index) => {
    const matchCount = numbers.filter(num => draw.includes(num)).length;
    if (matchCount >= 2) {
      appearedTogether++;
    }
    if (matchCount === numbers.length) {
      lastAppeared = data.length - index;
    }
  });
  
  // è¨ˆç®—èˆ‡æ­·å²å’Œå€¼çš„æ¯”è¼ƒ
  const historicalSums = data.map(draw => draw.reduce((a, b) => a + b, 0));
  const avgSum = historicalSums.reduce((a, b) => a + b, 0) / historicalSums.length;
  const sumDeviation = Math.abs(sum - avgSum);
  
  return {
    sum,
    oddCount,
    evenCount,
    span,
    appearedTogether,
    lastAppeared,
    sumDeviation,
    avgSum
  };
}

// é¡¯ç¤ºé©—è­‰çµæœ
function displayVerifyResults(results, numbers) {
  const panelB = document.getElementById('panelB');
  
  panelB.innerHTML = `
    <div class="box">
      <div class="box-title">ğŸ”¢ é©—è­‰çµ„åˆ</div>
      <div class="numbers-grid">
        ${numbers.map(num => `
          <div class="number-ball">${num}</div>
        `).join('')}
      </div>
    </div>
    
    <div class="stats-row">
      <div class="stat-item">
        <div class="stat-label">çµ„åˆå’Œå€¼</div>
        <div class="stat-value">${results.sum}</div>
      </div>
      <div class="stat-item">
        <div class="stat-label">å¥‡å¶æ¯”ä¾‹</div>
        <div class="stat-value">${results.oddCount}å¥‡${results.evenCount}å¶</div>
      </div>
      <div class="stat-item">
        <div class="stat-label">è™Ÿç¢¼è·¨åº¦</div>
        <div class="stat-value">${results.span}</div>
      </div>
      <div class="stat-item">
        <div class="stat-label">åŒæ™‚å‡ºç¾</div>
        <div class="stat-value">${results.appearedTogether}æ¬¡</div>
      </div>
    </div>
    
    <div class="status ${results.lastAppeared ? 'warning' : 'success'}">
      ${results.lastAppeared 
        ? `âš ï¸ æ­¤çµ„åˆæ›¾åœ¨ ${results.lastAppeared} æœŸå‰é–‹å‡ºé` 
        : 'âœ… æ­¤çµ„åˆå¾æœªåœ¨æ­·å²ä¸­é–‹å‡ºé'}
    </div>
    
    <div class="status ${results.sumDeviation < 20 ? 'success' : 'warning'}">
      ${results.sumDeviation < 20 
        ? `âœ… å’Œå€¼ ${results.sum} æ¥è¿‘æ­·å²å¹³å‡ ${results.avgSum.toFixed(1)}` 
        : `âš ï¸ å’Œå€¼ ${results.sum} èˆ‡æ­·å²å¹³å‡ ${results.avgSum.toFixed(1)} å·®ç•°è¼ƒå¤§`}
    </div>
  `;
}

// ç”Ÿæˆé æ¸¬
function generatePrediction() {
  if (!analysisCache) {
    alert('è«‹å…ˆé‹è¡Œæ™ºèƒ½åˆ†æ');
    return;
  }
  
  const loading = document.getElementById('loadingC');
  const panelC = document.getElementById('panelC');
  
  loading.style.display = 'block';
  panelC.style.display = 'none';
  
  // æ¨¡æ“¬ç”Ÿæˆå»¶é²
  setTimeout(() => {
    const prediction = generatePredictionCombination(analysisCache);
    displayPredictionResults(prediction);
    
    loading.style.display = 'none';
    panelC.style.display = 'block';
  }, 2000);
}

// ç”Ÿæˆé æ¸¬çµ„åˆ
function generatePredictionCombination(analysis) {
  const { numberStats, avgSum, avgOdd } = analysis;
  const candidates = [];
  
  // ç‚ºæ¯å€‹è™Ÿç¢¼è¨ˆç®—å¾—åˆ†
  Object.entries(numberStats).forEach(([num, stat]) => {
    let score = 0;
    
    // é »ç‡å¾—åˆ†
    score += stat.frequency * 2;
    
    // ç†±åº¦åŠ åˆ†
    if (stat.isHot) score += 10;
    
    // é©ç•¶çš„éºæ¼æœŸåŠ åˆ†ï¼ˆé¿å…å¤ªå†·æˆ–å¤ªç†±ï¼‰
    if (stat.lastSeen > 10 && stat.lastSeen < 50) {
      score += Math.min(5, stat.lastSeen / 10);
    }
    
    candidates.push({
      number: parseInt(num),
      score,
      stat
    });
  });
  
  // æŒ‰å¾—åˆ†æ’åº
  candidates.sort((a, b) => b.score - a.score);
  
  // åˆæ­¥é¸æ“‡å‰15å€‹
  const topCandidates = candidates.slice(0, 15);
  
  // ç”Ÿæˆçµ„åˆ
  let selected = new Set();
  let attempts = 0;
  
  while (selected.size < 5 && attempts < 1000) {
    // é‡ç½®é¸æ“‡
    selected.clear();
    
    // éš¨æ©Ÿé¸æ“‡5å€‹è™Ÿç¢¼ï¼Œä½†åŠ æ¬Šé«˜åˆ†è™Ÿç¢¼
    for (let i = 0; i < 5; i++) {
      // åŠ æ¬Šéš¨æ©Ÿé¸æ“‡
      const rand = Math.random() * topCandidates.reduce((sum, c) => sum + c.score, 0);
      let cumulative = 0;
      
      for (const candidate of topCandidates) {
        cumulative += candidate.score;
        if (cumulative >= rand && !selected.has(candidate.number)) {
          selected.add(candidate.number);
          break;
        }
      }
    }
    
    // æª¢æŸ¥ç´„æŸæ¢ä»¶
    const numbers = Array.from(selected);
    const sum = numbers.reduce((a, b) => a + b, 0);
    const oddCount = numbers.filter(n => n % 2 === 1).length;
    const sorted = [...numbers].sort((a, b) => a - b);
    const span = sorted[sorted.length - 1] - sorted[0];
    
    // ç´„æŸæ¢ä»¶
    const sumOk = Math.abs(sum - avgSum) < 30;
    const oddOk = Math.abs(oddCount - avgOdd) < 1.5;
    const spanOk = span > 20 && span < 40;
    
    if (sumOk && oddOk && spanOk) {
      break;
    }
    
    attempts++;
  }
  
  // å¦‚æœæ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„ï¼Œå–å‰5å€‹é«˜åˆ†
  if (selected.size < 5) {
    selected = new Set(candidates.slice(0, 5).map(c => c.number));
  }
  
  const finalNumbers = Array.from(selected).sort((a, b) => a - b);
  
  return {
    numbers: finalNumbers,
    sum: finalNumbers.reduce((a, b) => a + b, 0),
    oddCount: finalNumbers.filter(n => n % 2 === 1).length,
    generatedAt: new Date().toLocaleTimeString()
  };
}

// é¡¯ç¤ºé æ¸¬çµæœ
function displayPredictionResults(prediction) {
  const panelC = document.getElementById('panelC');
  
  panelC.innerHTML = `
    <div class="box">
      <div class="box-title">ğŸ¯ æ¨è–¦çµ„åˆ</div>
      <div class="numbers-grid">
        ${prediction.numbers.map(num => `
          <div class="number-ball">${num}</div>
        `).join('')}
      </div>
    </div>
    
    <div class="stats-row">
      <div class="stat-item">
        <div class="stat-label">çµ„åˆå’Œå€¼</div>
        <div class="stat-value">${prediction.sum}</div>
      </div>
      <div class="stat-item">
        <div class="stat-label">å¥‡å¶åˆ†ä½ˆ</div>
        <div class="stat-value">${prediction.oddCount}å¥‡${5 - prediction.oddCount}å¶</div>
      </div>
      <div class="stat-item">
        <div class="stat-label">ç”Ÿæˆæ™‚é–“</div>
        <div class="stat-value">${prediction.generatedAt}</div>
      </div>
      <div class="stat-item">
        <div class="stat-label">çµ„åˆæ•¸</div>
        <div class="stat-value">1çµ„</div>
      </div>
    </div>
    
    <div class="status success">
      ğŸ’¡ å»ºè­°ï¼šæ­¤çµ„åˆåŸºæ–¼æ­·å²æ•¸æ“šçš„çµ±è¨ˆç‰¹å¾µç”Ÿæˆï¼Œç¬¦åˆå¸¸è¦‹çš„å’Œå€¼ç¯„åœèˆ‡å¥‡å¶æ¯”ä¾‹
    </div>
    
    <div class="box">
      <div class="box-title">ğŸ“‹ çµ„åˆç‰¹å¾µ</div>
      <ul style="padding-left: 20px; color: #8da1b9;">
        <li>å’Œå€¼ï¼š${prediction.sum} (ä¸­ç­‰ç¯„åœ)</li>
        <li>å¥‡å¶æ¯”ï¼š${prediction.oddCount}:${5 - prediction.oddCount}</li>
        <li>è™Ÿç¢¼åˆ†ä½ˆï¼š${prediction.numbers.join(', ')}</li>
        <li>åŸºæ–¼ç†±è™Ÿèˆ‡çµ±è¨ˆå¹³è¡¡ç”Ÿæˆ</li>
      </ul>
    </div>
  `;
}

// é¡¯ç¤ºç‹€æ…‹æ¶ˆæ¯
function showStatus(elementId, message, type = 'info') {
  const element = document.getElementById(elementId);
  element.innerHTML = message;
  element.className = `status ${type}`;
}

// åˆå§‹åŒ–ç¤ºä¾‹æ•¸æ“šï¼ˆç”¨æ–¼æ¸¬è©¦ï¼‰
function loadSampleData() {
  // ç”Ÿæˆä¸€äº›ç¤ºä¾‹æ•¸æ“š
  const sampleData = [];
  for (let i = 0; i < 100; i++) {
    const draw = [];
    while (draw.length < 5) {
      const num = Math.floor(Math.random() * 49) + 1;
      if (!draw.includes(num)) {
        draw.push(num);
      }
    }
    sampleData.push(draw.sort((a, b) => a - b));
  }
  
  data = sampleData;
  displayCSVInfo(data);
}

// é é¢åŠ è¼‰å®Œæˆå¾Œå¯é¸åŠ è¼‰ç¤ºä¾‹æ•¸æ“š
window.addEventListener('DOMContentLoaded', () => {
  // å¯ä»¥é¸æ“‡åŠ è¼‰ç¤ºä¾‹æ•¸æ“šæˆ–ç•™ç©º
  // loadSampleData(); // å–æ¶ˆè¨»é‡‹ä»¥åŠ è¼‰ç¤ºä¾‹æ•¸æ“š
});

</script>
