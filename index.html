<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>539 AI Strategy Lab | æ¥µè‡´å„ªåŒ–ç‰ˆ</title>
    <style>
        :root { --primary: #e63946; --secondary: #1d3557; --success: #2a9d8f; --accent: #f4a261; --danger: #dc2626; --card-bg: #ffffff; }
        body { font-family: -apple-system, system-ui, sans-serif; margin: 0; background: #f0f2f5; color: #334155; font-size: 13px; }
        
        /* Layout */
        .header { background: var(--secondary); color: white; padding: 12px 24px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; }
        .main-container { max-width: 1300px; margin: 20px auto; padding: 0 20px; display: grid; grid-template-columns: 1fr 400px; gap: 20px; }

        /* Panels */
        .card { background: var(--card-bg); border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); margin-bottom: 20px; overflow: hidden; border: 1px solid #e2e8f0; }
        .card-header { padding: 14px 20px; background: #f8fafc; border-bottom: 1px solid #e2e8f0; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        
        /* Stats & Balls */
        .ball-display { display: flex; gap: 10px; justify-content: center; padding: 20px; }
        .ball { width: 42px; height: 42px; line-height: 42px; background: #ffca3a; border-radius: 10px; text-align: center; font-weight: bold; font-size: 1.2rem; border-bottom: 4px solid #eab308; transition: transform 0.2s; }
        .ball:hover { transform: translateY(-3px); }

        /* Heatmap Grid */
        .heatmap-grid { display: grid; grid-template-columns: repeat(13, 1fr); gap: 6px; padding: 15px; }
        .heat-cell { border-radius: 6px; padding: 8px 2px; text-align: center; font-weight: bold; position: relative; transition: 0.2s; cursor: help; }
        
        /* Controls */
        select, button { padding: 8px 16px; border-radius: 6px; border: 1px solid #cbd5e1; cursor: pointer; font-size: 0.85rem; }
        button.primary { background: var(--primary); color: white; border: none; font-weight: bold; }
        
        #dataAlert { background: #fff1f2; border: 1px solid #fda4af; color: #9f1239; padding: 12px; margin: 0 20px 20px; border-radius: 8px; display: none; }
        
        @media (max-width: 1000px) { .main-container { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<div class="header">
    <div style="font-size: 1.3rem; font-weight: bold;">ğŸ¯ 539 AI Strategy Lab <small style="font-size:0.7rem; opacity:0.7;">v4.0 Alpha</small></div>
    <div style="display:flex; gap:12px; align-items:center;">
        <select id="riskLevel" onchange="runAnalysis()">
            <option value="balanced">å¹³è¡¡å‹ç­–ç•¥</option>
            <option value="conservative">ä¿å®ˆå‹ (è¿½ç†±)</option>
            <option value="aggressive">ç©æ¥µå‹ (æå†·)</option>
        </select>
        <input type="file" id="csvFile" accept=".csv" style="display:none" onchange="bootEngine()">
        <button class="primary" onclick="document.getElementById('csvFile').click()">è¼‰å…¥ CSV</button>
        <button onclick="generateReport()">åŒ¯å‡ºå ±å‘Š</button>
    </div>
</div>

<div class="main-container">
    <div class="left-pane">
        <div id="dataAlert"></div>

        <div class="card">
            <div class="card-header">ğŸ§¬ è’™ç‰¹å¡ç¾…åŠ æ¬Šçµ„åˆ (ç¶“å¤šæ¨£æ€§å„ªåŒ–)</div>
            <div id="finalPortfolio" class="ball-display">
                <span style="color:#94a3b8">è«‹è¼‰å…¥æ•¸æ“šä»¥å•Ÿå‹•æ¨¡æ“¬å¼•æ“</span>
            </div>
        </div>

        <div class="card">
            <div class="card-header">ğŸ“ˆ æ™ºèƒ½åŠ æ¬Šç†±åŠ›åœ– <span style="font-size:0.7rem; font-weight:normal;">(è¿‘æœŸæ¬Šé‡ 2.5x)</span></div>
            <div id="advancedHeatmap"></div>
        </div>
    </div>

    <div class="right-pane">
        <div class="card">
            <div class="card-header">ğŸ“Š ç­–ç•¥å›æ¸¬æŒ‡æ¨™</div>
            <div id="metricsPanel" style="padding:20px;">
                <p style="color:#64748b">ç­‰å¾…åˆ†æ...</p>
            </div>
        </div>

        <div class="card">
            <div class="card-header">ğŸ” æ•¸æ“šå®Œæ•´æ€§æª¢æŸ¥</div>
            <div id="healthCheck" style="padding:20px;">æœªæƒæ</div>
        </div>
    </div>
</div>

<script>
    let db = [];
    const strategyCache = new Map();

    // --- 1. æ ¸å¿ƒå•Ÿå‹•èˆ‡è§£æ ---
    async function bootEngine() {
        const file = document.getElementById('csvFile').files[0];
        if(!file) return;
        
        const text = await file.text();
        const rows = text.split('\n').filter(r => r.trim());
        
        db = rows.map(r => {
            const cols = r.split(',');
            const nums = cols.slice(1, 6).map(n => parseInt(n.trim()));
            return {
                date: cols[0],
                nums: nums.filter(n => !isNaN(n) && n >= 1 && n <= 39).sort((a,b)=>a-b)
            };
        }).filter(r => r.nums.length === 5);

        validateData();
        runAnalysis();
    }

    // --- 2. æ¼”ç®—æ³•æ·±åº¦å„ªåŒ– ---
    function getWeightedHotAdvanced(data = db) {
        const freq = {};
        data.forEach((r, idx) => {
            const weight = idx > data.length - 15 ? 2.5 : 1.0;
            r.nums.forEach(n => freq[n] = (freq[n] || 0) + weight);
        });
        return Object.entries(freq).sort((a,b)=>b[1]-a[1]).slice(0, 10).map(e=>Number(e[0]));
    }

    function getSmartColdNumbers(data = db) {
        const missing = {};
        for(let n=1; n<=39; n++) {
            const idx = [...data].reverse().findIndex(r => r.nums.includes(n));
            missing[n] = idx === -1 ? data.length : idx;
        }
        return Object.entries(missing).sort((a,b)=>b[1]-a[1]).slice(0, 5).map(e=>Number(e[0]));
    }

    function getDynamicTail(data = db) {
        const tails = {};
        data.slice(-20).forEach(r => r.nums.forEach(n => tails[n%10] = (tails[n%10] || 0) + 1));
        const bestTail = Object.entries(tails).sort((a,b)=>b[1]-a[1])[0][0];
        return Array.from({length:4}, (_,i) => i*10 + Number(bestTail)).filter(n => n>=1 && n<=39);
    }

    function getConnectionPatterns(data = db) {
        const scores = {};
        data.slice(-30).forEach(r => {
            for(let i=0; i<r.nums.length-1; i++) {
                if(r.nums[i+1] - r.nums[i] <= 2) {
                    scores[r.nums[i]] = (scores[r.nums[i]] || 0) + 1;
                    scores[r.nums[i+1]] = (scores[r.nums[i+1]] || 0) + 1;
                }
            }
        });
        return Object.entries(scores).sort((a,b)=>b[1]-a[1]).slice(0, 5).map(e=>Number(e[0]));
    }

    // --- 3. è’™ç‰¹å¡ç¾…åŠ æ¬Šæ¨¡æ“¬ ---
    function runAnalysis() {
        if(!db.length) return;
        const risk = document.getElementById('riskLevel').value;
        const profiles = {
            conservative: { hot: 0.45, cold: 0.15, tail: 0.3, conn: 0.1 },
            balanced: { hot: 0.35, cold: 0.25, tail: 0.25, conn: 0.15 },
            aggressive: { hot: 0.2, cold: 0.4, tail: 0.2, conn: 0.2 }
        };
        const base = profiles[risk];
        const votes = {};

        for(let i=0; i<1000; i++) {
            const rf = () => 0.8 + Math.random() * 0.4;
            getWeightedHotAdvanced().forEach(n => votes[n] = (votes[n]||0) + base.hot * rf());
            getSmartColdNumbers().forEach(n => votes[n] = (votes[n]||0) + base.cold * rf());
            getDynamicTail().forEach(n => votes[n] = (votes[n]||0) + base.tail * rf());
            getConnectionPatterns().forEach(n => votes[n] = (votes[n]||0) + base.conn * rf());
        }

        const candidates = Object.entries(votes).sort((a,b)=>b[1]-a[1]).map(e=>Number(e[0]));
        const optimized = optimizePortfolio(candidates);
        
        renderResults(optimized);
        renderAdvancedHeatmap();
        performBacktest(optimized);
    }

    // --- 4. çµ„åˆå„ªåŒ–ï¼šåˆ†æ•£é¢¨éšª ---
    function optimizePortfolio(candidates) {
        const final = [];
        const tails = new Set();
        for(let n of candidates) {
            if(final.length < 5) {
                if(final.length < 3 && tails.has(n%10)) continue;
                final.push(n);
                tails.add(n%10);
            }
        }
        return final.sort((a,b)=>a-b);
    }

    // --- 5. è¦–è¦ºåŒ–æ¸²æŸ“ ---
    function renderAdvancedHeatmap() {
        const heatmapData = Array(39).fill(0);
        db.forEach((r, idx) => {
            const w = idx > db.length - 15 ? 2.5 : 1.0;
            r.nums.forEach(n => heatmapData[n-1] += w);
        });
        const max = Math.max(...heatmapData);
        let html = '<div class="heatmap-grid">';
        heatmapData.forEach((v, i) => {
            const intensity = (v / max) * 100;
            const color = `hsl(${10 + intensity * 0.4}, 80%, ${85 - intensity * 0.4}%)`;
            html += `<div class="heat-cell" style="background:${color}" title="åŠ æ¬Šåˆ†: ${v.toFixed(1)}">${i+1}</div>`;
        });
        document.getElementById('advancedHeatmap').innerHTML = html + '</div>';
    }

    function renderResults(nums) {
        document.getElementById('finalPortfolio').innerHTML = nums.map(n => 
            `<div class="ball">${n < 10 ? '0'+n : n}</div>`
        ).join('');
    }

    function performBacktest(portfolio) {
        const trials = Math.min(db.length, 30);
        let h2 = 0, h3 = 0;
        for(let i=0; i<trials; i++) {
            const match = portfolio.filter(n => db[db.length-1-i].nums.includes(n)).length;
            if(match >= 2) h2++;
            if(match >= 3) h3++;
        }
        document.getElementById('metricsPanel').innerHTML = `
            <div style="margin-bottom:10px"><b>è¿‘æœŸå‘½ä¸­ç‡ (30æœŸå›æ¸¬):</b></div>
            <div style="font-size:1.2rem; color:var(--success); font-weight:bold;">2+ å‘½ä¸­: ${(h2/trials*100).toFixed(1)}%</div>
            <div style="font-size:1.1rem; color:var(--primary);">3+ å‘½ä¸­: ${(h3/trials*100).toFixed(1)}%</div>
            <div style="font-size:0.75rem; color:#64748b; margin-top:10px;">* åŸºæ–¼è’™ç‰¹å¡ç¾…æ¨¡æ“¬ä¹‹æœŸæœ›å€¼</div>
        `;
    }

    function validateData() {
        const health = document.getElementById('healthCheck');
        health.innerHTML = `âœ… æª¢æŸ¥å®Œæˆ: ${db.length} æœŸæœ‰æ•ˆæ•¸æ“š`;
    }

    function generateReport() {
        const data = {
            date: new Date().toLocaleString(),
            risk: document.getElementById('riskLevel').value,
            result: document.getElementById('finalPortfolio').innerText,
            db_size: db.length
        };
        const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `539_AI_Report.json`;
        a.click();
    }
</script>

</body>
</html>
