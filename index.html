<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>預測模擬系統 - 優化版</title>
<style>
body {
  margin: 0;
  font-family: -apple-system, BlinkMacSystemFont;
  background: #0f1a2b;
  color: #ffffff;
}
.panel {
  padding: 16px;
  border-bottom: 1px solid #24324a;
}
h2 { margin:0 0 12px 0; font-size:18px; }
button, select, input { width:100%; padding:14px; font-size:16px; margin-top:8px; border-radius:10px; border:none; }
button { background:#1e3a5f; color:#fff; }
.log-item { background:#16253d; padding:12px; border-radius:10px; margin-bottom:10px; }
.small { font-size:13px; opacity:0.8; }
</style>
</head>

<body>

<!-- Panel 1 -->
<div class="panel">
  <h2>Panel 1｜資料與回測</h2>
  <input type="file" id="csvInput" accept=".csv">
  <button onclick="runBacktest()">執行回測</button>
</div>

<!-- Panel 2 -->
<div class="panel">
  <h2>Panel 2｜近 10 期回測 Log + 2星命中率%</h2>
  <select id="strategySelect" onchange="renderLogs()"></select>
  <div id="logContainer"></div>
  <div class="small">可透過下方 Panel 優化策略參數以提升命中率</div>
</div>

<!-- Panel 3 -->
<div class="panel">
  <h2>Panel 3｜策略說明</h2>
  <div id="strategyDesc"></div>
</div>

<!-- Panel 4 -->
<div class="panel">
  <h2>Panel 4｜實戰預測（未來）</h2>
  <select id="liveStrategySelect"></select>
  <button onclick="runLivePrediction()">產生預測</button>
  <div id="liveResult"></div>
</div>

<!-- Panel 5: 優化參數 -->
<div class="panel">
  <h2>Panel 5｜策略參數優化</h2>
  <select id="optStrategySelect"></select>
  <button onclick="optimizeParams()">測試不同 N</button>
  <div id="optResult"></div>
</div>

<script>
let data = []
let logs = {}

// ===== 策略定義 =====
const strategies = {
  hotDynamic: {
    name: "動態熱號",
    description: "根據最近 N 期出現頻率選號，可調 N",
    params: {N:10},
    predict(history, params={N:10}) {
      const recent = history.slice(-params.N)
      return pickByFrequency(recent)
    }
  },
  coldDynamic: {
    name: "動態冷號",
    description: "挑選長期未出現的號碼，可調 N",
    params: {N:10},
    predict(history, params={N:10}) {
      return pickByFrequency(history.slice(-params.N), true)
    }
  }
}

// ===== CSV 讀取 =====
document.getElementById("csvInput").addEventListener("change", e => {
  const file = e.target.files[0]
  if (!file) return
  const reader = new FileReader()
  reader.onload = () => parseCSV(reader.result)
  reader.readAsText(file)
})

function parseCSV(text) {
  const rows = text.trim().split("\n")
  data = rows.slice(1).map(r=>{
    const [date,...nums] = r.split(",")
    return { date, numbers: nums.map(n=>parseInt(n,10)) }
  })
}

// ===== 回測主流程（鎖死） =====
function runBacktest() {
  logs = {}
  Object.keys(strategies).forEach(k=>logs[k]=[])
  for(let i=3;i<data.length;i++){
    const history = data.slice(0,i)
    const actual = data[i].numbers
    const date = data[i].date
    for(const key in strategies){
      const predicted = strategies[key].predict(history, strategies[key].params)
      const hit = predicted.filter(n=>actual.includes(n)).length
      logs[key].push({date, actual, predicted, hit})
    }
  }
  populateSelects()
  renderLogs()
  renderStrategyDesc()
}

// ===== Panel 2 =====
function renderLogs() {
  const key = document.getElementById("strategySelect").value
  const container = document.getElementById("logContainer")
  container.innerHTML = ""
  if(!logs[key]) return
  const recentLogs = logs[key].slice(-10).reverse()
  let twoStarHits = 0
  recentLogs.forEach(r=>{
    if(r.hit>=2) twoStarHits++
    container.innerHTML+=`
      <div class="log-item">
        <div>${r.date}</div>
        <div class="small">開獎：${r.actual.join(" ")}</div>
        <div class="small">預測：${r.predicted.join(" ")}</div>
        <div>命中：${r.hit}</div>
      </div>
    `
  })
  const rate = recentLogs.length?((twoStarHits/recentLogs.length)*100).toFixed(1):0
  container.innerHTML+=`<div class="log-item"><strong>近10期2星以上命中率: ${rate}%</strong></div>`
}

// ===== Panel 3 =====
function renderStrategyDesc() {
  const box = document.getElementById("strategyDesc")
  box.innerHTML = Object.values(strategies).map(s=>`
    <div class="log-item">
      <strong>${s.name}</strong>
      <div class="small">${s.description}</div>
    </div>
  `).join("")
}

// ===== Panel 4 =====
function runLivePrediction() {
  if(data.length===0) return
  const key = document.getElementById("liveStrategySelect").value
  const strategy = strategies[key]
  const history = data.slice(0)
  const predicted = strategy.predict(history, strategy.params)
  document.getElementById("liveResult").innerHTML=`
    <div class="log-item">
      <div>策略：${strategy.name}</div>
      <div class="small">資料：${history[0].date} ～ ${history[history.length-1].date}</div>
      <div>預測號碼：<strong>${predicted.join(" ")}</strong></div>
    </div>
  `
}

// ===== Panel 5 優化參數 =====
function optimizeParams(){
  const key = document.getElementById("optStrategySelect").value
  const strategy = strategies[key]
  const Nvalues = [5,6,7,8,9,10,11,12,13,14,15]
  let resultHTML = ''
  Nvalues.forEach(N=>{
    strategy.params.N = N
    runBacktest()
    const log = logs[key].slice(-10)
    const twoStar = log.filter(r=>r.hit>=2).length
    const rate = log.length?((twoStar/log.length)*100).toFixed(1):0
    resultHTML+=`<div class="log-item">N=${N} → 2星命中率: ${rate}%</div>`
  })
  document.getElementById("optResult").innerHTML=resultHTML
}

// ===== 共用 =====
function populateSelects(){
  const selects = [
    document.getElementById("strategySelect"),
    document.getElementById("liveStrategySelect"),
    document.getElementById("optStrategySelect")
  ]
  selects.forEach(sel=>{
    sel.innerHTML = ''
    for(const k in strategies){
      sel.innerHTML+=`<option value="${k}">${strategies[k].name}</option>`
    }
  })
}

// ===== 工具 =====
function pickByFrequency(history, reverse=false){
  const freq={}
  history.forEach(d=>d.numbers.forEach(n=>freq[n]=(freq[n]||0)+1))
  return Object.keys(freq)
    .sort((a,b)=>reverse?freq[a]-freq[b]:freq[b]-freq[a])
    .slice(0,5)
    .map(Number)
}
</script>

</body>
</html>
