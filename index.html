<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>539 Advanced Tactical Center</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --bg: #020617; --card: #0f172a; --accent: #38bdf8; --hot: #ef4444; --cold: #3b82f6; --gold: #fbbf24; --success: #22c55e; }
        body { margin: 0; background: var(--bg); color: #f1f5f9; font-family: system-ui, sans-serif; padding: 10px; font-size: 14px; }
        .dashboard { max-width: 1300px; margin: 0 auto; display: grid; grid-template-columns: 1fr 420px; gap: 12px; }
        .panel { background: var(--card); border-radius: 12px; padding: 16px; border: 1px solid #1e293b; }
        .full { grid-column: 1 / -1; }
        
        /* åœ–è¡¨ */
        .chart-box { height: 260px; margin-top: 10px; }

        /* çƒç›¤åˆ†ç´šèˆ‡æ¨è–¦ */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)); gap: 8px; }
        .ball { 
            aspect-ratio: 1; border-radius: 10px; display: flex; flex-direction: column; 
            align-items: center; justify-content: center; cursor: pointer; transition: 0.2s;
            position: relative; overflow: hidden; background: #1e293b; border: 2px solid transparent;
        }
        .ball .num { font-size: 18px; font-weight: 800; z-index: 2; }
        .ball .rank-badge { position: absolute; top: 2px; left: 2px; font-size: 8px; padding: 1px 3px; border-radius: 3px; z-index: 3; color: white; font-weight: bold; }
        .ball .meta { font-size: 8px; opacity: 0.7; z-index: 2; }
        .ball.selected { border-color: #fff; transform: scale(0.92); box-shadow: 0 0 10px rgba(255,255,255,0.3); }

        /* å›æ¸¬æ—¥èªŒ */
        .bt-box { background: #000; color: var(--success); font-family: monospace; padding: 10px; border-radius: 6px; font-size: 12px; height: 120px; overflow-y: auto; margin-top: 10px; }
        
        /* æ§åˆ¶å€ */
        .row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        select, input { background: #020617; color: #fff; border: 1px solid #334155; padding: 4px 8px; border-radius: 6px; }
        .btn { width: 100%; padding: 12px; border-radius: 8px; border: none; font-weight: 700; cursor: pointer; margin-bottom: 6px; }
        .btn-ai { background: linear-gradient(135deg, #0ea5e9, #6366f1); color: white; }
        .btn-test { background: transparent; border: 1px solid var(--success); color: var(--success); }

        #result { margin-top: 10px; font-family: monospace; color: #4ade80; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 6px; display: none; }
    </style>
</head>
<body>

<div class="dashboard">
    <div class="panel full">
        <div class="row">
            <h3 style="margin:0">æˆ°ç•¥çœ‹æ¿ (å’Œå€¼ç·š + å¥‡å¶æŸ± + é€£è™Ÿæ•£é»)</h3>
            <input type="file" onchange="handleFile(this)">
        </div>
        <div class="chart-box"><canvas id="mainChart"></canvas></div>
        <div id="bt-log" class="bt-box">ç­‰å¾…æ•¸æ“šè®€å–ä»¥åŸ·è¡Œå›æ¸¬...</div>
    </div>

    <div class="panel">
        <div class="row">
            <b>AI æ¨è–¦ç´šåˆ¥èˆ‡é€£è™Ÿæ½›åŠ›</b>
            <span id="sel-info" style="font-size:12px; color:var(--gold)">æœªé¸è™Ÿ</span>
        </div>
        <div id="grid" class="grid"></div>
    </div>

    <div class="panel">
        <h3 style="margin:0; margin-bottom:12px">AI ç­–ç•¥é¸è™Ÿç”Ÿæˆ</h3>
        <div class="row"><span>å¥‡å¶æ¯”ä¾‹</span><select id="p-oe"><option value="any">ä¸é™</option><option value="3:2">3å¥‡:2å¶</option><option value="2:3">2å¥‡:3å¶</option></select></div>
        <div class="row"><span>å¤§å°æ¯”ä¾‹</span><select id="p-bs"><option value="any">ä¸é™</option><option value="3:2">3å¤§:2å°</option><option value="2:3">2å¤§:3å°</option></select></div>
        <div class="row"><span>é€£è™Ÿè¦æ±‚</span><select id="p-con"><option value="any">ä¸é™</option><option value="yes">å¿…é ˆåŒ…å«</option><option value="no">æ’é™¤é€£è™Ÿ</option></select></div>
        <div class="row"><span>å’Œå€¼å€é–“</span><span><input type="number" id="p-min" value="80" style="width:40px">-<input type="number" id="p-max" value="125" style="width:40px"></span></div>
        <div class="row"><span>å›æ¸¬æ·±åº¦</span><select id="p-bt-depth"><option value="10">æœ€è¿‘ 10 æœŸ</option><option value="30">æœ€è¿‘ 30 æœŸ</option><option value="50">æœ€è¿‘ 50 æœŸ</option></select></div>
        
        <button class="btn btn-ai" onclick="generateAI()">åŸ·è¡Œç­–ç•¥ç”Ÿæˆ</button>
        <button class="btn btn-test" onclick="runBacktest()">åŸ·è¡Œæ·±åº¦å›æ¸¬</button>
        <div id="result"></div>
    </div>
</div>

<script>
    let raw = [], stats = { freq: {}, gap: {}, scores: {}, last: [] }, selected = new Set(), chart;

    function handleFile(input) {
        const reader = new FileReader();
        reader.onload = (e) => {
            const lines = e.target.result.split('\n').filter(l => l.trim() !== "").slice(1);
            stats.freq = {}; stats.gap = {}; for(let i=1; i<=39; i++) stats.gap[i] = lines.length;
            
            raw = lines.map((l, idx) => {
                const c = l.split(',');
                const nums = c.slice(1,6).map(Number).sort((a,b)=>a-b);
                if(idx === 0) stats.last = nums;
                nums.forEach(n => {
                    stats.freq[n] = (stats.freq[n]||0)+1;
                    if(stats.gap[n] > idx) stats.gap[n] = idx;
                });
                return { date: c[0].slice(5), nums, sum: nums.reduce((a,b)=>a+b,0), odd: nums.filter(n=>n%2!==0).length, con: nums.some((n,i)=> n === nums[i-1]+1) };
            }).reverse();

            updateScores();
            renderChart();
            renderGrid();
            runBacktest();
        };
        reader.readAsText(input.files[0]);
    }

    function updateScores() {
        // AI æ¬Šé‡ç®—æ³•å„ªåŒ–ï¼šè¿‘æœŸç†±åº¦ + é•·æœŸéºæ¼è£œå„Ÿ
        for(let i=1; i<=39; i++) {
            stats.scores[i] = (stats.freq[i]||0)*1.2 + (stats.gap[i]||0)*0.8;
        }
    }

    function renderGrid() {
        const grid = document.getElementById('grid'); grid.innerHTML = '';
        const sorted = Object.entries(stats.scores).sort((a,b)=>b[1]-a[1]);

        for(let i=1; i<=39; i++) {
            const ball = document.createElement('div');
            const rank = sorted.findIndex(x => x[0] == i) + 1;
            let level = '', color = '#1e293b';
            
            if(rank <= 3) { level = `TOP${rank}`; color = '#ef4444'; }
            else if(rank <= 10) { level = 'æ¨è–¦'; color = '#fbbf24'; }

            ball.className = `ball ${selected.has(i) ? 'selected' : ''}`;
            ball.innerHTML = `
                ${level ? `<div class="rank-badge" style="background:${color}">${level}</div>` : ''}
                <span class="num">${String(i).padStart(2,'0')}</span>
                <span class="meta">æ¼${stats.gap[i]||0} | é–‹${stats.freq[i]||0}</span>
                <div style="position:absolute; bottom:0; width:100%; height:4px; background:hsla(200, 70%, 50%, ${rank < 15 ? 0.8 : 0.2})"></div>
            `;
            ball.onclick = () => {
                if(selected.has(i)) selected.delete(i); else if(selected.size < 5) selected.add(i);
                updateInfo(); renderGrid();
            };
            grid.appendChild(ball);
        }
    }

    function runBacktest() {
        const depth = parseInt(document.getElementById('p-bt-depth').value);
        const log = document.getElementById('bt-log');
        log.innerHTML = `âš™ï¸ åŸ·è¡Œ ${depth} æœŸæ·±åº¦å›æ¸¬ä¸­...<br>`;
        let totalHits = 0;
        
        const testData = raw.slice(-depth);
        testData.forEach(d => {
            const top10 = Object.entries(stats.scores).sort((a,b)=>b[1]-a[1]).slice(0, 10).map(x=>Number(x[0]));
            const hits = d.nums.filter(n => top10.includes(n));
            totalHits += hits.length;
        });

        log.innerHTML += `âœ… å›æ¸¬å®Œæˆ<br>ğŸ“Š å¹³å‡æ¯æœŸå‘½ä¸­: ${(totalHits/depth).toFixed(2)} ç¢¼ (æ¡ Top 10 æ¨è–¦è™Ÿ)<br>`;
        log.innerHTML += `ğŸ¯ å‘½ä¸­ç‡åˆ†ä½ˆ: ${((totalHits/(depth*5))*100).toFixed(1)}%`;
    }

    function generateAI() {
        const qty = 3; let results = [], attempts = 0;
        const conf = { oe: document.getElementById('p-oe').value, bs: document.getElementById('p-bs').value, con: document.getElementById('p-con').value, min: parseInt(document.getElementById('p-min').value), max: parseInt(document.getElementById('p-max').value) };
        
        let pool = [];
        Object.entries(stats.scores).forEach(([n, s]) => { for(let k=0; k<Math.floor(s); k++) pool.push(Number(n)); });

        while(results.length < qty && attempts < 10000) {
            attempts++;
            let temp = new Set();
            while(temp.size < 5) temp.add(pool[Math.floor(Math.random()*pool.length)]);
            let arr = Array.from(temp).sort((a,b)=>a-b);
            const sum = arr.reduce((a,b)=>a+b), o = arr.filter(n=>n%2!==0).length, b = arr.filter(n=>n>=20).length, c = arr.some((n,i)=> n === arr[i-1]+1);
            
            if(attempts === 5000) { conf.min -= 10; conf.max += 10; } // è‡ªå‹•æ”¾å¯¬

            if((conf.oe === 'any' || conf.oe === `${o}:${5-o}`) && (conf.bs === 'any' || conf.bs === `${b}:${5-b}`) && (sum >= conf.min && sum <= conf.max) && (conf.con === 'any' || (conf.con === 'yes' ? c : !c))) {
                results.push(arr.map(n=>String(n).padStart(2,'0')).join(' '));
            }
        }
        const resBox = document.getElementById('result'); resBox.style.display = 'block';
        resBox.innerText = `[ç­–ç•¥ç”Ÿæˆæ¨è–¦]\n` + results.map((r,i)=>`æ–¹æ¡ˆ ${i+1}: ${r}`).join('\n');
    }

    function renderChart() {
        const ctx = document.getElementById('mainChart').getContext('2d');
        if(chart) chart.destroy();
        const data = raw.slice(-30);
        chart = new Chart(ctx, {
            data: {
                labels: data.map(d => d.date),
                datasets: [
                    { type: 'line', label: 'å’Œå€¼', data: data.map(d=>d.sum), borderColor: '#fbbf24', yAxisID: 'y' },
                    { type: 'bar', label: 'å¥‡æ•¸æ•¸', data: data.map(d=>d.odd), backgroundColor: 'rgba(239, 68, 68, 0.4)', yAxisID: 'y1' },
                    { type: 'scatter', label: 'é€£è™ŸæœŸ', data: data.map((d,i)=> d.con ? {x: d.date, y: 5.5} : null), backgroundColor: '#fff', yAxisID: 'y1' }
                ]
            },
            options: { responsive: true, maintainAspectRatio: false, scales: { y1: { position: 'right', max: 6 } } }
        });
    }

    function updateInfo() {
        const arr = Array.from(selected);
        document.getElementById('sel-info').innerText = `é¸ ${arr.length} | å‡å€¼ ${arr.length ? (arr.reduce((a,b)=>a+b)/arr.length).toFixed(1) : 0}`;
    }
</script>
</body>
</html>
