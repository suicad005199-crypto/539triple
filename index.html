<!-- ⚠️ 上半部 HTML / CSS 完全不變，直接沿用你的 -->
<!-- 以下只貼 <script> 區塊，請整段覆蓋 -->

<script>
let HIST_DATA = [];
let CORR_MATRIX = {};

document.getElementById('csvFile').addEventListener('change', e=>{
    document.getElementById('fileLabel').innerText =
        e.target.files[0]?.name || "點擊選取歷史數據 CSV";
});

async function runAll(){
    const f = document.getElementById("csvFile").files[0];
    if(!f){ alert("請先選取 CSV"); return; }

    const text = await f.text();
    HIST_DATA = parseCSV(text);
    if(HIST_DATA.length < 50){
        alert("資料期數不足，建議至少 50 期");
        return;
    }

    buildCorrelationMatrix(HIST_DATA);
    showHistory(HIST_DATA);
    renderQuantResult();
    renderBacktest();

    alert("量化分析完成");
}

/* ---------- CSV ---------- */
function parseCSV(text){
    const lines = text.trim().split(/\r?\n/);
    lines.shift();
    return lines.map(l=>{
        const p=l.split(",");
        if(p.length<6) return null;
        const nums=p.slice(1,6).map(n=>+n).sort((a,b)=>a-b);
        if(nums.some(isNaN)) return null;
        return {date:p[0],nums};
    }).filter(Boolean).sort((a,b)=>new Date(a.date)-new Date(b.date));
}

/* ---------- 關聯矩陣 ---------- */
function buildCorrelationMatrix(data){
    CORR_MATRIX = {};
    for(let i=0;i<data.length-1;i++){
        data[i].nums.forEach(c=>{
            CORR_MATRIX[c] = CORR_MATRIX[c] || {};
            data[i+1].nums.forEach(n=>{
                CORR_MATRIX[c][n] = (CORR_MATRIX[c][n]||0) + 1;
            });
        });
    }
}

/* ---------- 顯示歷史 ---------- */
function showHistory(data){
    let html="<table>";
    data.slice(-5).reverse().forEach(d=>{
        html+=`<tr><td style="opacity:.5">${d.date}</td><td>${
            d.nums.map(n=>`<span class="ball">${String(n).padStart(2,"0")}</span>`).join("")
        }</td></tr>`;
    });
    html+="</table>";
    document.getElementById("history").innerHTML="<h3>近期開獎歷史</h3>"+html;
}

/* ---------- 量化推薦 ---------- */
function renderQuantResult(){
    const lastNums = HIST_DATA.at(-1).nums;
    let score = {};

    lastNums.forEach(c=>{
        const rel = CORR_MATRIX[c] || {};
        Object.keys(rel).forEach(n=>{
            if(lastNums.includes(+n)) return;
            score[n] = (score[n]||0) + rel[n];
        });
    });

    const picks = Object.entries(score)
        .sort((a,b)=>b[1]-a[1])
        .slice(0,5)
        .map(e=>+e[0])
        .sort((a,b)=>a-b);

    document.getElementById("recommendContent").innerHTML = `
        <p>基於前一期條件共現模型推薦：</p>
        <div>${picks.map(n=>`<span class="ball">${String(n).padStart(2,"0")}</span>`).join("")}</div>
    `;
    document.getElementById("recommendContent").style.opacity=1;
}

/* ---------- 策略回測 ---------- */
function renderBacktest(){
    let hitSum=0, hit2=0, hit3=0, count=0;

    for(let i=30;i<HIST_DATA.length-1;i++){
        const prev = HIST_DATA[i].nums;
        let s={};

        prev.forEach(c=>{
            const rel=CORR_MATRIX[c]||{};
            Object.keys(rel).forEach(n=>{
                if(prev.includes(+n)) return;
                s[n]=(s[n]||0)+rel[n];
            });
        });

        const pick = Object.entries(s)
            .sort((a,b)=>b[1]-a[1])
            .slice(0,5)
            .map(e=>+e[0]);

        const actual = HIST_DATA[i+1].nums;
        const hit = pick.filter(n=>actual.includes(n)).length;

        hitSum+=hit;
        if(hit>=2) hit2++;
        if(hit>=3) hit3++;
        count++;
    }

    document.getElementById("stats_table").innerHTML = `
        <h3>策略回測表現</h3>
        <table>
            <tr><th>樣本期數</th><th>平均命中</th><th>≥2 顆</th><th>≥3 顆</th></tr>
            <tr>
                <td>${count}</td>
                <td>${(hitSum/count).toFixed(2)}</td>
                <td>${(hit2/count*100).toFixed(1)}%</td>
                <td>${(hit3/count*100).toFixed(1)}%</td>
            </tr>
        </table>
    `;
}
</script>
