<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>539 回測系統｜≥3 高置信盤</title>
<style>
body { font-family: Arial; padding: 20px; }
.hit { color: red; font-weight: bold; }
.period { margin-top: 20px; border-top: 2px solid #444; padding-top: 10px; }
</style>
</head>
<body>

<h2>539 回測系統（≥3 高置信盤型）</h2>
<input type="file" id="csvFile" accept=".csv">
<br><button onclick="run()">執行回測</button>

<div id="summary"></div>
<div id="detail"></div>

<script>
function parseCSV(t){
  return t.trim().split("\n").slice(1).map(r=>{
    const p=r.split(",");
    return {date:p[0], nums:p.slice(1).map(Number)};
  });
}

function run(){
  const f=document.getElementById("csvFile").files[0];
  if(!f) return alert("請上傳 CSV");
  const r=new FileReader();
  r.onload=()=>{
    const d=parseCSV(r.result);

    let total=0, played=0, hit3=0;
    let detail="";

    for(let i=30;i<d.length;i++){
      total++;
      const hist=d.slice(0,i);
      const act=d[i];

      const gap={}, freq={}, tailFreq={};
      for(let n=1;n<=39;n++){ gap[n]=0; freq[n]=0; }
      hist.slice(-10).forEach(dr=>{
        dr.nums.forEach(n=>{
          freq[n]++;
          tailFreq[n%10]=(tailFreq[n%10]||0)+1;
        });
      });

      hist.forEach(dr=>{
        for(let n=1;n<=39;n++) gap[n]++;
        dr.nums.forEach(n=>gap[n]=0);
      });

      // 評分
      const score={};
      for(let n=1;n<=39;n++){
        let s=0;
        if(freq[n]>=3) s+=3;
        if(gap[n]>=10) s+=2;
        score[n]=s;
      }

      const pool=Object.keys(score)
        .sort((a,b)=>score[b]-score[a])
        .slice(0,7).map(Number);

      // 熱度同步
      if(pool.filter(n=>freq[n]>=3).length<4) continue;

      // 組合
      const combos=[];
      for(let a=0;a<pool.length;a++)
      for(let b=a+1;b<pool.length;b++)
      for(let c=b+1;c<pool.length;c++)
      for(let e=c+1;e<pool.length;e++)
      for(let f=e+1;f<pool.length;f++){
        const p=[pool[a],pool[b],pool[c],pool[e],pool[f]];

        // 尾數共振
        const tails={};
        p.forEach(n=>tails[n%10]=(tails[n%10]||0)+1);
        let ok=false;
        for(const t in tails){
          if(tails[t]>=2 && tailFreq[t]>=3) ok=true;
        }
        if(!ok) continue;

        // 總和
        const sum=p.reduce((x,n)=>x+n,0);
        if(sum<80||sum>105) continue;

        const ps=p.reduce((x,n)=>x+score[n],0);
        combos.push({p, ps});
      }

      combos.sort((a,b)=>b.ps-a.ps);
      if(combos.length===0) continue;

      played++;
      const plays=combos.slice(0,3);
      let max=0;

      plays.forEach(c=>{
        let h=0;
        c.p.forEach(n=>{ if(act.nums.includes(n)) h++; });
        if(h>max) max=h;
      });

      if(max>=3) hit3++;

      detail+=`
        <div class="period">
          ${act.date}｜開獎：${act.nums.join(", ")}<br>
          出手：${plays.map(c=>c.p.join("-")).join(" / ")}<br>
          本期最高命中：${max}
        </div>
      `;
    }

    document.getElementById("summary").innerHTML=`
      可回測期數：${total}<br>
      出手期數：${played}<br>
      出手期 ≥3：${played? (hit3/played*100).toFixed(1):0}%
    `;
    document.getElementById("detail").innerHTML=detail;
  };
  r.readAsText(f);
}
</script>
</body>
</html>
