<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>必中 v1</title>
<style>
body{margin:0;font-family:-apple-system;background:#0b1626;color:#fff}
h1{text-align:center;color:#00ff99;margin:12px 0}
.panel{margin:12px;padding:14px;border-radius:14px}
.p0{background:#050b15}
.p1{background:#0f1f38}
.p2{background:#142b4d}
.p3{background:#1a355c}
.p4{background:#203f6e}
h2{font-size:17px;margin-bottom:8px}
button,input{width:100%;padding:10px;border-radius:10px;border:none;margin-top:6px}
button{background:#274c77;color:#fff}
.box{background:#0c1a30;border-radius:10px;padding:8px;margin-top:6px}
.small{font-size:13px;opacity:.9}
.ok{color:#00ff99}
.bad{color:#ff6666}
</style>
</head>
<body>

<!-- Panel 0 -->
<div class="panel p0">
  <h1>必中 v1</h1>
</div>

<!-- Panel 1 -->
<div class="panel p1">
  <h2>Panel 1｜資料層（CSV）</h2>
  <input type="file" id="csvInput" accept=".csv">
  <div id="csvInfo" class="small"></div>
</div>

<!-- Panel A -->
<div class="panel p2">
  <h2>Panel A｜兩階段策略（研究）</h2>
  <button onclick="runStageA()">執行</button>
  <div id="panelA"></div>
</div>

<!-- Panel B -->
<div class="panel p3">
  <h2>Panel B｜反向驗證（指定組合）</h2>
  <input id="verifyInput" placeholder="例：1 2 16 33 35">
  <button onclick="runVerify()">分析</button>
  <div id="panelB"></div>
</div>

<!-- Panel C -->
<div class="panel p4">
  <h2>Panel C｜實戰預測（折衷）</h2>
  <button onclick="runStageC()">產生預測</button>
  <div id="panelC"></div>
</div>

<script>
let data=[]

document.getElementById("csvInput").addEventListener("change",e=>{
  const r=new FileReader()
  r.onload=()=>{
    data=r.result.trim().split(/\r?\n/).slice(1).map(l=>{
      const c=l.split(",")
      return{date:c[0],numbers:c.slice(1).map(Number)}
    })
    document.getElementById("csvInfo").innerText=
      `共 ${data.length} 期，範圍 ${data[0].date} ～ ${data.at(-1).date}`
  }
  r.readAsText(e.target.files[0])
})

/* ===== 共用計算 ===== */
function stats(){
  const freq={}, last={}
  data.forEach((d,i)=>d.numbers.forEach(n=>{
    freq[n]=(freq[n]||0)+1
    last[n]=i
  }))
  return{freq,last,T:data.length}
}

/* ===== Panel A ===== */
function runStageA(){
  const {freq,last,T}=stats()
  const pool=Object.keys(freq).map(Number).filter(n=>{
    const f=freq[n]/T
    const d=T-last[n]
    return f>0.03 && f<0.15 && d>5 && d<30
  })
  const combos=[]
  for(let i=0;i<pool.length;i++)
   for(let j=i+1;j<pool.length;j++)
    for(let k=j+1;k<pool.length;k++)
     for(let l=k+1;l<pool.length;l++)
      for(let m=l+1;m<pool.length;m++){
        const c=[pool[i],pool[j],pool[k],pool[l],pool[m]]
        if(Math.max(...c)-Math.min(...c)>=20) combos.push(c)
      }
  document.getElementById("panelA").innerHTML=
    `<div class="box small">號碼池：${pool.join(" ")}</div>
     <div class="box small">可行組合數：${combos.length}</div>`
}

/* ===== Panel B ===== */
function runVerify(){
  const input=document.getElementById("verifyInput").value
  const nums=input.split(/\s+/).map(Number)
  const {freq,last,T}=stats()
  let html=""
  nums.forEach(n=>{
    const f=(freq[n]||0)/T
    const d=T-(last[n]??0)
    html+=`<div class="small">${n}｜
      穩定 ${f.toFixed(3)}｜
      延遲 ${d}
    </div>`
  })
  const span=Math.max(...nums)-Math.min(...nums)
  html+=`<div class="small ${span>=20?"ok":"bad"}">跨度 ${span}</div>`
  document.getElementById("panelB").innerHTML=`<div class="box">${html}</div>`
}

/* ===== Panel C ===== */
function runStageC(){
  const {freq,last,T}=stats()
  const ranked=Object.keys(freq).sort((a,b)=>{
    return (freq[b]/T)-(freq[a]/T)+(last[a]-last[b])*0.001
  }).map(Number)
  const pick=[]
  for(const n of ranked){
    if(pick.length===0||Math.max(...pick,n)-Math.min(...pick,n)>=15){
      pick.push(n)
    }
    if(pick.length===5)break
  }
  document.getElementById("panelC").innerHTML=
    `<div class="box small">預測號碼：${pick.join(" ")}</div>`
}
</script>
</body>
</html>
