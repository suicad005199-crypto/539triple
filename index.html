<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>539 策略回測與智能選牌系統</title>
<style>
:root {
    --primary-color: #1a3a5f;
    --accent-color: #3e95cd;
    --success-color: #28a745;
    --bg-color: #f0f2f5;
    --card-bg: #ffffff;
}
body { font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif; background: var(--bg-color); margin:0;padding:20px;color:#333;line-height:1.6;}
.container { max-width:1200px;margin:0 auto; }
header { text-align:center; margin-bottom:30px; padding:20px; background: var(--primary-color); color:white; border-radius:12px; box-shadow:0 4px 15px rgba(0,0,0,0.1);}
.upload-section { background: var(--card-bg); padding:20px; border-radius:12px; text-align:center; margin-bottom:20px; box-shadow:0 2px 10px rgba(0,0,0,0.05);}
input[type=file]{margin:10px 0;}
button{background:var(--accent-color);color:white;border:none;padding:10px 20px;border-radius:6px;font-weight:bold;cursor:pointer;transition:0.3s;margin:5px;}
button:hover{background:#2d7da1; transform:translateY(-2px);}
.dashboard-grid { display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-bottom:20px; }
.card{background:var(--card-bg);padding:20px;border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,0.05);}
table{width:100%;border-collapse:collapse;margin-top:10px;}
th,td{padding:10px;border-bottom:1px solid #eee;text-align:center;}
th{background:#f8f9fa;color:var(--primary-color);}
.ball{display:inline-block;width:32px;height:32px;line-height:32px;text-align:center;border-radius:50%;background:#e9ecef;margin:2px;font-weight:bold;font-size:14px;}
.high-rate .ball{background: var(--success-color); color:white; box-shadow:0 2px 5px rgba(40,167,69,0.4);}
.strategy-block{border-left:5px solid var(--accent-color); padding-left:10px; margin:15px 0; background:#fcfcfc;}
.rate-badge{font-size:12px;padding:3px 8px;border-radius:12px;background:#eee;margin-left:5px;}
.chart-container{background:white;padding:20px;border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,0.05);margin-top:20px;}
.pick-btn{background:#f1f3f5;color:#495057;border:1px solid #dee2e6;padding:4px 8px;border-radius:4px;font-size:12px;margin-right:10px;cursor:default;}
.inline-input{width:40px;text-align:center;margin:0 3px;}
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<div class="container">
<header>
<h1>539 策略分析與智能回測系統</h1>
<p>基於歷史數據的機率評估模型</p>
</header>

<div class="upload-section">
<label><strong>Step 1: 匯入歷史數據 (CSV)</strong></label><br>
<input type="file" id="csvFile" accept=".csv"><br>
<button onclick="runAll()">執行系統回測</button>
</div>

<div class="dashboard-grid">
<div id="history" class="card"><h3>最近 5 期歷史</h3><p style="color:gray">等待數據載入...</p></div>
<div id="stats_table" class="card"><h3>策略歷史表現</h3><p style="color:gray">等待數據載入...</p></div>
</div>

<div id="results" class="card">
<h3>智能建議組合</h3>
<p style="color:gray">請先執行回測以產生基於勝率排序的組合...</p>
</div>

<div class="card" style="margin-top:20px;">
<h3>策略 D - 自選號碼驗證</h3>
<p>輸入 5 個號碼 (1~39)，按驗證命中率</p>
<input type="number" min="1" max="39" class="inline-input" id="userNum1">
<input type="number" min="1" max="39" class="inline-input" id="userNum2">
<input type="number" min="1" max="39" class="inline-input" id="userNum3">
<input type="number" min="1" max="39" class="inline-input" id="userNum4">
<input type="number" min="1" max="39" class="inline-input" id="userNum5">
<button onclick="verifyUserPick()">驗證命中率</button>
<div id="userPickResult" style="margin-top:10px; font-size:14px; color:#333;"></div>
</div>

<div class="chart-container">
<canvas id="trendChart"></canvas>
</div>
</div>

<script>
const RULES = [
{ name: "A_保守型", pool: "last1+5", desc:"追蹤上期熱碼並進行位移補捉。" },
{ name: "B_均衡型", pool: "last5+5+10", desc:"擴大樣本至最近5期，平衡冷熱號碼。" },
{ name: "C_進取型", pool: "last5+10", desc:"針對大幅跳號設計的積極型擴展策略。" }
];

let HIST_DATA = [];

async function runAll(){
    const fileInput=document.getElementById("csvFile");
    if(!fileInput.files[0]){ alert("請先載入 CSV 檔"); return; }
    const text=await fileInput.files[0].text();
    const data=parseCSV(text);
    HIST_DATA=data;

    showHistory(data);
    const stats=doBacktest(data);
    renderStatsTable(stats);
    drawTrendChart(stats.map(s=>s.hit2Rate*100), stats.map(s=>s.hit3Rate*100));
    renderTopCombinations(data, stats);
    renderNextPeriod(data);
}

function parseCSV(text){
    const lines=text.trim().split("\n");
    lines.shift();
    return lines.map(l=>{
        const p=l.split(",");
        return {date:p[0], nums:p.slice(2,7).map(n=>parseInt(n))};
    }).sort((a,b)=>new Date(a.date)-new Date(b.date));
}

function showHistory(data){
    let html="<h3>最近 5 期開獎</h3><table><tr><th>日期</th><th>號碼</th></tr>";
    data.slice(-5).reverse().forEach(d=>{
        html+=`<tr><td>${d.date}</td><td>${d.nums.map(n=>`<span class="ball">${String(n).padStart(2,'0')}</span>`).join("")}</td></tr>`;
    });
    html+="</table>";
    document.getElementById("history").innerHTML=html;
}

function doBacktest(data){
    const stats=RULES.map(r=>({rule:r, hit5:0, hit4:0, hit3:0, hit2:0, total:0}));
    for(let i=5;i<data.length;i++){
        const prev=data.slice(i-5,i), actual=data[i].nums;
        stats.forEach(s=>{
            const pick=generatePick(prev,s.rule);
            const hit=countHit(actual,pick);
            s.total++; if(hit>=2)s.hit2++; if(hit>=3)s.hit3++; if(hit>=4)s.hit4++; if(hit==5)s.hit5++;
        });
    }
    stats.forEach(s=>{
        s.hit2Rate=s.hit2/s.total; s.hit3Rate=s.hit3/s.total;
        s.hit4Rate=s.hit4/s.total; s.hit5Rate=s.hit5/s.total;
    });
    return stats;
}

function renderStatsTable(stats){
    let html="<h3>策略歷史表現</h3><table><tr><th>策略</th><th>中3率</th><th>中2率</th><th>測試期數</th></tr>";
    stats.forEach(s=>{
        html+=`<tr><td><strong>${s.rule.name}</strong></td><td>${(s.hit3Rate*100).toFixed(2)}%</td><td>${(s.hit2Rate*100).toFixed(2)}%</td><td>${s.total}</td></tr>`;
    });
    html+="</table>";
    document.getElementById("stats_table").innerHTML=html;
}

function drawTrendChart(hit2Data,hit3Data){
    const ctx=document.getElementById("trendChart").getContext("2d");
    if(window.myChart)window.myChart.destroy();
    window.myChart=new Chart(ctx,{
        type:'bar',
        data:{ labels:RULES.map(r=>r.name), datasets:[
            { label:'歷史 ≥2 碼命中率 (%)', data: hit2Data, backgroundColor:'#3e95cd' },
            { label:'歷史 ≥3 碼命中率 (%)', data: hit3Data, backgroundColor:'#1a3a5f' }
        ]},
        options:{ responsive:true, scales:{ y:{ beginAtZero:true, max:100 } }, plugins:{ title:{ display:true, text:'策略勝率對比圖' } } }
    });
}

function countHit(actual,pick){ return actual.filter(n=>pick.includes(n)).length; }
function estimateHitRate(pick,data,minHit){
    let count=0; data.forEach(d=>{ if(countHit(d.nums,pick)>=minHit) count++; });
    return count/data.length;
}

function buildPool(latest5,rule){
    const pool=new Set();
    if(rule.pool.includes("last1")) latest5[4].nums.forEach(n=>pool.add(n));
    if(rule.pool.includes("last5")) latest5.forEach(d=>d.nums.forEach(n=>pool.add(n)));
    [...pool].forEach(n=>{
        if(rule.pool.includes("+5") && n+5<=39) pool.add(n+5);
        if(rule.pool.includes("+10") && n+10<=39) pool.add(n+10);
    });
    return [...pool];
}

function generatePick(prev,rule){
    const pool=buildPool(prev,rule);
    return shuffle(pool).slice(0,5).sort((a,b)=>a-b);
}
function shuffle(arr){ return arr.sort(()=>Math.random()-0.5); }

function renderTopCombinations(data, stats){
    const resultsDiv=document.getElementById("results");
    resultsDiv.innerHTML="<h3>智能建議組合 (前三組最佳)</h3>";

    stats.forEach(s=>{
        const pool=buildPool(data.slice(-5), s.rule);
        const candidates=[];
        for(let i=0;i<50;i++){
            const pick=shuffle(pool).slice(0,5).sort((a,b)=>a-b);
            const hit2=estimateHitRate(pick,data,2);
            const hit3=estimateHitRate(pick,data,3);
            const hit4=estimateHitRate(pick,data,4);
            candidates.push({pick, hit2, hit3, hit4});
        }
        candidates.sort((a,b)=> ((b.hit2+b.hit3)/2)-((a.hit2+a.hit3)/2));

        const bestAvg=(candidates[0].hit2+candidates[0].hit3)/2;

        const sBlock=document.createElement("div");
        sBlock.className="strategy-block";
        sBlock.innerHTML=`<h4>策略：${s.rule.name} <small style="color:gray; font-weight:normal;">${s.rule.desc}</small></h4>`;

        candidates.slice(0,3).forEach((p,i)=>{
            const avgRate=(p.hit2+p.hit3)/2;
            const isHigh=(avgRate===bestAvg);
            const ballsHtml=p.pick.map(n=>`<span class="ball">${String(n).padStart(2,'0')}</span>`).join("");
            sBlock.innerHTML+=`<div style="margin-bottom:10px;" class="${isHigh?'high-rate':''}">
                <span class="pick-btn">組合 ${i+1}</span>
                ${ballsHtml}
                <span class="rate-badge">中2+: ${(p.hit2*100).toFixed(1)}%</span>
                <span class="rate-badge">中3+: ${(p.hit3*100).toFixed(1)}%</span>
                <span class="rate-badge">中4+: ${(p.hit4*100).toFixed(1)}%</span>
                ${isHigh?'<b style="color:#28a745; margin-left:5px;">★ 最佳組合</b>':''}
            </div>`;
        });
        resultsDiv.appendChild(sBlock);
    });
}

function verifyUserPick(){
    if(HIST_DATA.length==0){ alert("請先載入 CSV"); return; }
    const pick=[
        parseInt(document.getElementById("userNum1").value),
        parseInt(document.getElementById("userNum2").value),
        parseInt(document.getElementById("userNum3").value),
        parseInt(document.getElementById("userNum4").value),
        parseInt(document.getElementById("userNum5").value)
    ].filter(n=>!isNaN(n) && n>=1 && n<=39);
    if(pick.length!=5){ alert("請輸入 5 個有效號碼 (1~39)"); return; }

    const hit2=estimateHitRate(pick,HIST_DATA,2);
    const hit3=estimateHitRate(pick,HIST_DATA,3);
    const hit4=estimateHitRate(pick,HIST_DATA,4);
    const hit5=estimateHitRate(pick,HIST_DATA,5);

    document.getElementById("userPickResult").innerHTML=
        `自選組合 <strong>${pick.map(n=>n.toString().padStart(2,'0')).join(',')}</strong><br>
        命中率: 中2+ ${(hit2*100).toFixed(1)}%, 中3+ ${(hit3*100).toFixed(1)}%, 中4+ ${(hit4*100).toFixed(1)}%, 中5 ${(hit5*100).toFixed(1)}%`;
}

function renderNextPeriod(data){
    const resultsDiv=document.getElementById("results");
    const nextDiv=document.createElement("div");
    nextDiv.className="strategy-block";
    nextDiv.innerHTML="<h4>下期推薦組合</h4>";

    const pool=new Set();
    data.slice(-10).forEach(d=>d.nums.forEach(n=>pool.add(n)));
    const poolArr=[...pool];
    const candidates=[];
    for(let i=0;i<50;i++){
        const pick=shuffle(poolArr).slice(0,5).sort((a,b)=>a-b);
        const hit2=estimateHitRate(pick,data,2);
        const hit3=estimateHitRate(pick,data,3);
        candidates.push({pick, hit2, hit3});
    }
    candidates.sort((a,b)=> ((b.hit2+b.hit3)/2)-((a.hit2+a.hit3)/2));
    const bestAvg=(candidates[0].hit2+candidates[0].hit3)/2;

    candidates.slice(0,3).forEach((p,i)=>{
        const ballsHtml=p.pick.map(n=>`<span class="ball">${String(n).padStart(2,'0')}</span>`).join("");
        const isBest=( (p.hit2+p.hit3)/2 === bestAvg );
        nextDiv.innerHTML+=`<div style="margin-bottom:10px;" class="${isBest?'high-rate':''}">
            <span class="pick-btn">組合 ${i+1}</span>${ballsHtml}
            <span class="rate-badge">勝率 MEMO: ${((p.hit2+p.hit3)/2*100).toFixed(1)}%</span>
            ${isBest?'<b style="color:#28a745; margin-left:5px;">★ 最佳組合</b>':''}
        </div>`;
    });

    resultsDiv.appendChild(nextDiv);
}
</script>
</body>
</html>
