<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSV æ•¸æ“šå›æ¸¬åˆ†æç³»çµ±</title>
    <style>
        :root { --primary: #2c3e50; --accent: #e74c3c; --success: #27ae60; --bg: #f4f7f6; }
        body { font-family: "Microsoft JhengHei", sans-serif; background: var(--bg); margin: 0; padding: 20px; }
        .panel { background: white; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); padding: 20px; margin-bottom: 20px; max-width: 1200px; margin-left: auto; margin-right: auto; }
        .panel-title { margin: 0 0 15px 0; color: var(--primary); border-left: 5px solid var(--primary); padding-left: 12px; font-size: 1.1rem; }
        
        /* é æ¸¬å¡ç‰‡ */
        .grid-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; }
        .card { background: #f8f9fa; padding: 15px; border-radius: 8px; border-top: 4px solid var(--primary); }
        .num-badge { display: inline-block; background: var(--primary); color: white; border-radius: 4px; padding: 2px 8px; margin: 2px; font-weight: bold; }
        .hit-badge { background: var(--success) !important; }

        /* åˆ†å¸ƒåœ– */
        .table-container { overflow-x: auto; }
        table { border-collapse: collapse; width: 100%; white-space: nowrap; background: white; }
        th, td { border: 1px solid #eee; text-align: center; padding: 8px; font-size: 12px; }
        th { background: var(--primary); color: white; position: sticky; top: 0; }
        .dot { background: var(--accent); color: white; border-radius: 50%; display: inline-block; width: 20px; height: 20px; line-height: 20px; font-weight: bold; }

        /* å›æ¸¬ç´€éŒ„ */
        .backtest-row:nth-child(even) { background: #f9f9f9; }
        .hit-count { font-weight: bold; color: var(--success); font-size: 1.1rem; }

        /* ç‹€æ…‹æ¨™ç±¤ */
        .status-tag { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 11px; margin: 2px; border: 1px solid #ddd; }
        
        /* æ”¶åˆ */
        .accordion-header { cursor: pointer; background: #eee; padding: 10px; border-radius: 6px; font-weight: bold; text-align: center; }
        .accordion-content { display: none; padding: 15px; line-height: 1.6; font-size: 14px; background: #fff; border: 1px solid #eee; }
    </style>
</head>
<body>

    <div class="panel">
        <h3 class="panel-title">1. æ•¸æ“šä¸Šå‚³ (æ”¯æ´æ¨™é¡Œåˆ— CSV)</h3>
        <input type="file" id="csvFile" accept=".csv">
        <div id="statusTracker" style="margin-top:15px; display: flex; flex-wrap: wrap;"></div>
    </div>

    <div id="analysisSection" style="display:none;">
        <div class="panel">
            <h3 class="panel-title">2. æ™ºèƒ½é æ¸¬ (ä¸‹ä¸€æœŸ)</h3>
            <div class="grid-container" id="predictionResults"></div>
        </div>

        <div class="panel">
            <h3 class="panel-title">3. é€£è™Ÿåˆ†å¸ƒåœ– (æœ€æ–° 10 æœŸ)</h3>
            <div class="table-container">
                <table id="distributionTable"><thead><tr id="chartHeader"></tr></thead><tbody id="chartBody"></tbody></table>
            </div>
        </div>

        <div class="panel">
            <h3 class="panel-title">4. æ»¾å‹•å›æ¸¬ç´€éŒ„ (æ¯”å°é æ¸¬èˆ‡çœŸå¯¦é–‹ç)</h3>
            <div class="table-container">
                <table>
                    <thead>
                        <tr><th>æ—¥æœŸ</th><th>çœŸå¯¦çè™Ÿ</th><th>é æ¸¬çµ„åˆ</th><th>å‘½ä¸­æ•¸</th></tr>
                    </thead>
                    <tbody id="backtestBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="panel">
        <div class="accordion-header" onclick="toggleAccordion()">ç­–ç•¥é‚è¼¯èªªæ˜ (é»æ“Šå±•é–‹)</div>
        <div id="accContent" class="accordion-content">
            <strong>â— æ•¸æ“šè®€å–ï¼š</strong> è‡ªå‹•è·³éæ¨™é¡Œåˆ—ï¼Œæ”¯æ´æ—¥æœŸèˆ‡ 5 å€‹çè™Ÿè§£æã€‚<br>
            <strong>â— å›æ¸¬æ©Ÿåˆ¶ï¼š</strong> æ¯ä¸€æœŸé æ¸¬çš†ã€Œåªä½¿ç”¨è©²æœŸä»¥å‰ã€çš„è³‡æ–™ï¼Œæ¨¡æ“¬çœŸå¯¦ç›²æ¸¬ã€‚<br>
            <strong>â— ç­–ç•¥æ¬Šé‡ï¼š</strong> çµåˆå†·ç†±å¹³è¡¡æ¼”ç®—æ³•èˆ‡ä¸ŠæœŸå°¾æ•¸é„°è¿‘è¦å¾‹ã€‚
        </div>
    </div>

    <script>
        document.getElementById('csvFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = e => parseCSV(e.target.result);
            reader.readAsText(file);
        });

        function parseCSV(text) {
            const lines = text.split(/\r?\n/);
            const data = [];
            
            lines.forEach((line, index) => {
                const cols = line.split(',').map(s => s.trim());
                // è·³éæ¨™é¡Œåˆ— (åˆ¤æ–·ç¬¬ä¸€æ ¼æ˜¯å¦åŒ…å«éæ•¸å­—å­—å…ƒï¼Œå¦‚ "æ—¥æœŸ")
                if (index === 0 && isNaN(cols[1])) return;
                if (cols.length >= 6 && cols[0] !== "") {
                    const date = cols[0];
                    const nums = cols.slice(1, 6).map(n => parseInt(n)).sort((a,b) => a-b);
                    data.push({ date, nums });
                }
            });

            if (data.length > 0) {
                processSystem(data);
                document.getElementById('analysisSection').style.display = 'block';
            }
        }

        function processSystem(data) {
            const latest10 = [...data].slice(-10).reverse();
            renderChart(latest10);
            renderStatusTracker(data);
            runBacktest(data);
            generateNext(data);
        }

        // æ ¸å¿ƒé æ¸¬æ¼”ç®—æ³•
        function getSmartPick(history) {
            const freq = {};
            history.forEach(row => {
                row.nums.forEach(n => freq[n] = (freq[n] || 0) + 1);
            });

            const sorted = Array.from({length: 39}, (_, i) => (i + 1))
                                .sort((a, b) => (freq[b] || 0) - (freq[a] || 0));
            
            const hot = sorted.slice(0, 2); // å–ç†±é–€ 2 å€‹
            const cold = sorted.slice(-10).sort(() => Math.random() - 0.5).slice(0, 2); // å–å†·é–€éš¨æ©Ÿ 2 å€‹
            const lastNum = history[history.length - 1].nums[0];
            const neighbor = (lastNum + 1) > 39 ? 1 : lastNum + 1; // é„°è¿‘ 1 å€‹

            return [...new Set([...hot, ...cold, neighbor])].slice(0, 5).sort((a,b) => a-b);
        }

        function runBacktest(allData) {
            const tbody = document.getElementById('backtestBody');
            tbody.innerHTML = '';
            // å¾æœ€å¾Œä¸€æœŸå¾€å›æ¸¬ 10 æœŸ
            for (let i = allData.length - 1; i >= Math.max(0, allData.length - 10); i--) {
                const historyBefore = allData.slice(0, i);
                if (historyBefore.length < 5) continue; 

                const actual = allData[i].nums;
                const pred = getSmartPick(historyBefore);
                const hits = pred.filter(n => actual.includes(n));

                tbody.innerHTML += `
                    <tr class="backtest-row">
                        <td>${allData[i].date}</td>
                        <td>${actual.join(', ')}</td>
                        <td>${pred.map(n => `<span class="num-badge ${actual.includes(n) ? 'hit-badge' : ''}">${n}</span>`).join('')}</td>
                        <td class="hit-count">${hits.length}</td>
                    </tr>`;
            }
        }

        function renderChart(data) {
            const header = document.getElementById('chartHeader');
            const body = document.getElementById('chartBody');
            header.innerHTML = '<th>æ—¥æœŸ</th>' + Array.from({length: 39}, (_, i) => `<th>${i+1}</th>`).join('');
            body.innerHTML = data.map(row => {
                let tr = `<td>${row.date}</td>`;
                for (let i = 1; i <= 39; i++) {
                    tr += `<td>${row.nums.includes(i) ? `<span class="dot">${i}</span>` : ''}</td>`;
                }
                return `<tr>${tr}</tr>`;
            }).join('');
        }

        function renderStatusTracker(allData) {
            const tracker = document.getElementById('statusTracker');
            const last = allData[allData.length - 1].nums;
            tracker.innerHTML = '';
            for (let i = 1; i <= 39; i++) {
                let count = 0;
                const isHit = last.includes(i);
                for (let j = allData.length - 1; j >= 0; j--) {
                    if (allData[j].nums.includes(i) === isHit) count++; else break;
                }
                const bg = isHit ? '#ffeaa7' : '#dfe6e9';
                tracker.innerHTML += `<span class="status-tag" style="background:${bg}">${i}:${isHit?'é€£':'æœª'}${count}</span>`;
            }
        }

        function generateNext(allData) {
            const res = document.getElementById('predictionResults');
            const p = getSmartPick(allData);
            res.innerHTML = `
                <div class="card"><h4>ğŸ¯ ä¸‹æœŸå»ºè­° (åŸºæ–¼å…¨æ•¸æ“š)</h4>${p.map(n => `<span class="num-badge" style="font-size:1.2rem; padding:5px 15px;">${n}</span>`).join('')}</div>
                <div class="card"><h4>ğŸ“Š æ•¸æ“šç‰¹å¾µ</h4>ç›®å‰æ•¸æ“šå…± ${allData.length} æœŸã€‚å»ºè­°è§€å¯Ÿå›æ¸¬å‘½ä¸­æ•¸ï¼Œè‹¥é€£ 3 æœŸå‘½ä¸­ç‚º 0ï¼Œå‰‡ä¸‹æœŸæ©Ÿç‡å¢åŠ ã€‚</div>
            `;
        }

        function toggleAccordion() {
            const c = document.getElementById('accContent');
            c.style.display = c.style.display === 'block' ? 'none' : 'block';
        }
    </script>
</body>
</html>
