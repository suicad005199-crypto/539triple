<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>539 回測＋建議號碼系統（含回測每組號碼勝率）</title>
<style>
body { font-family: Arial, sans-serif; padding: 20px; background:#f7f7f7; }
input, button { margin-top: 10px; padding: 8px; font-size:14px; }
#results, #history { margin-top: 20px; background:#fff; padding:15px; border-radius:8px; box-shadow:0 0 5px rgba(0,0,0,0.1); }
.chart-container { width: 90%; margin-top: 40px; background:#fff; padding:20px; border-radius:8px; box-shadow:0 0 5px rgba(0,0,0,0.1); }
table { border-collapse: collapse; width: 100%; background:#fff; }
th, td { border: 1px solid #333; padding: 5px 10px; text-align: center; }
th { background: #3e95cd; color: #fff; }
tr:nth-child(even) { background: #f2f2f2; }
h2,h3,h4 { margin-bottom: 10px; }
.pick-btn { margin-right:5px; padding:2px 6px; font-size:12px; cursor:pointer; }
.high-rate { color:green; font-weight:bold; }
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<h2>539 回測 + 建議號碼系統（含回測每組勝率）</h2>

<label>載入歷史開獎 CSV：</label><br>
<input type="file" id="csvFile" accept=".csv"><br>
<button onclick="runAll()">執行回測 + 顯示圖表 + 產生建議</button>

<div id="history"></div>
<div id="results"></div>
<div class="chart-container">
  <canvas id="trendChart"></canvas>
</div>

<script>
// 規則定義
const RULES = [
  { name: "A_保守", pool: "last1+5", odd: [2,3], sum: [85,115], desc:"保守策略：last1期 + 位移+5" },
  { name: "B_均衡", pool: "last5+5+10", odd: [1,2,3,4], sum: [80,120], desc:"均衡策略：last5期 + 位移+5,+10" },
  { name: "C_進取", pool: "last5+10", odd: [3], sum: [90,125], desc:"進取策略：last5期 + 位移+10" }
];

// 主流程
async function runAll() {
  const fileInput = document.getElementById("csvFile");
  if (!fileInput.files[0]) { alert("請先載入 CSV 檔"); return; }

  const text = await fileInput.files[0].text();
  const data = parseCSV(text);

  // 顯示最近 5 期歷史開獎號碼
  showHistory(data);

  // 回測每條規則的歷史命中率
  const stats = doBacktest(data);
  renderStats(stats);

  // 顯示圖表
  drawTrendChart(stats.map(s=>s.hit2Rate*100), stats.map(s=>s.hit3Rate*100));

  // 生成每條規則的 3 組建議號碼，並回測每組命中率
  let html = document.getElementById("results").innerHTML;
  stats.forEach(s => {
    let picksWithRate = [];
    for(let i=0;i<3;i++){
      const pick = generateNextPick(data.slice(-5), s.rule);
      // 回測該組號碼在歷史資料的命中率
      const hit2 = estimateHitRate(pick, data, 2);
      const hit3 = estimateHitRate(pick, data, 3);
      const hit4 = estimateHitRate(pick, data, 4);
      const hit5 = estimateHitRate(pick, data, 5);
      picksWithRate.push({pick, hit2, hit3, hit4, hit5});
    }
    // 按平均命中率排序 (簡單平均≥2碼 + ≥3碼)
    picksWithRate.sort((a,b)=> ((b.hit2+b.hit3)/2)-((a.hit2+a.hit3)/2));

    html += `<h3>規則：${s.rule.name}</h3>`;
    picksWithRate.forEach((p,i)=>{
      html += `<button class="pick-btn" onclick="alert('${s.rule.desc}')">選牌邏輯</button>`;
      let pickHtml = p.pick.map(n=>{
        const avgRate = (p.hit2+p.hit3)/2;
        return avgRate>=0.6?`<span class="high-rate">${n}</span>`:n;
      }).join(", ");
      html += `組 ${i+1}: ${pickHtml} | 5中5: ${(p.hit5*100).toFixed(2)}%, 5中4: ${(p.hit4*100).toFixed(2)}%, 5中3: ${(p.hit3*100).toFixed(2)}%, 5中2: ${(p.hit2*100).toFixed(2)}%<br>`;
    });
  });
  document.getElementById("results").innerHTML = html;
}

// 顯示最近 5 期開獎號碼
function showHistory(data){
  let html = "<h3>最近 5 期歷史開獎號碼</h3><table><tr><th>日期</th><th>號碼</th></tr>";
  const last5 = data.slice(-5).reverse();
  last5.forEach(d=>{
    html += `<tr><td>${d.date}</td><td>${d.nums.join(", ")}</td></tr>`;
  });
  html += "</table>";
  document.getElementById("history").innerHTML = html;
}

// CSV解析
function parseCSV(text){
  const lines = text.trim().split("\n");
  lines.shift(); // 去掉標題
  return lines.map(l=>{
    const p=l.split(",");
    return {date:p[0], nums:p.slice(2,7).map(n=>parseInt(n))};
  }).sort((a,b)=>new Date(a.date)-new Date(b.date));
}

// 回測每條規則
function doBacktest(data){
  const stats = RULES.map(r=>({rule:r, hit5:0, hit4:0, hit3:0, hit2:0, total:0}));
  for(let i=5;i<data.length;i++){
    const prev=data.slice(i-5,i), actual=data[i].nums;
    stats.forEach(s=>{
      const pick=generatePick(prev,s.rule);
      const hit = countHit(actual,pick);
      s.total++;
      if(hit>=2) s.hit2++;
      if(hit>=3) s.hit3++;
      if(hit>=4) s.hit4++;
      if(hit==5) s.hit5++;
    });
  }
  stats.forEach(s=>{
    s.hit2Rate = s.hit2/s.total;
    s.hit3Rate = s.hit3/s.total;
    s.hit4Rate = s.hit4/s.total;
    s.hit5Rate = s.hit5/s.total;
  });
  return stats;
}

// 顯示回測統計
function renderStats(stats){
  let html = "<h3>回測結果（歷史命中率）</h3>";
  html += "<table><tr><th>規則</th><th>5中5</th><th>5中4</th><th>5中3</th><th>5中2</th><th>總期數</th></tr>";
  stats.forEach(s=>{
    html += `<tr>
      <td>${s.rule.name}</td>
      <td>${(s.hit5Rate*100).toFixed(2)}%</td>
      <td>${(s.hit4Rate*100).toFixed(2)}%</td>
      <td>${(s.hit3Rate*100).toFixed(2)}%</td>
      <td>${(s.hit2Rate*100).toFixed(2)}%</td>
      <td>${s.total}</td>
    </tr>`;
  });
  html += "</table>";
  document.getElementById("results").innerHTML = html;
}

// 趨勢圖
function drawTrendChart(hit2Data, hit3Data){
  const ctx = document.getElementById("trendChart").getContext("2d");
  new Chart(ctx,{
    type:'bar',
    data:{
      labels: RULES.map(r=>r.name),
      datasets:[
        { label:'≥2 碼命中率 (%)', data: hit2Data, backgroundColor:'#8e5ea2' },
        { label:'≥3 碼命中率 (%)', data: hit3Data, backgroundColor:'#3e95cd' }
      ]
    },
    options:{ scales:{ y:{ beginAtZero:true, max:100 } } }
  });
}

// 生成建議號碼
function generateNextPick(latest5, rule){
  const pool = buildPool(latest5, rule);
  return shuffle(pool).slice(0,5).sort((a,b)=>a-b);
}

// 工具
function countHit(actual,pick){ return actual.filter(n=>pick.includes(n)).length; }
function estimateHitRate(pick,data,minHit){
  let count=0; data.forEach(d=>{ if(countHit(d.nums,pick)>=minHit) count++; });
  return count/data.length;
}
function buildPool(latest5,rule){
  const pool = new Set();
  if(rule.pool.includes("last1")) latest5[4].nums.forEach(n=>pool.add(n));
  if(rule.pool.includes("last5")) latest5.forEach(d=>d.nums.forEach(n=>pool.add(n)));
  [...pool].forEach(n=>{
    if(rule.pool.includes("+5") && n+5<=39) pool.add(n+5);
    if(rule.pool.includes("+10") && n+10<=39) pool.add(n+10);
  });
  return [...pool];
}
function generatePick(prev,rule){ const pool=buildPool(prev,rule); return shuffle(pool).slice(0,5).sort((a,b)=>a-b); }
function shuffle(arr){ return arr.sort(()=>Math.random()-0.5); }

</script>
</body>
</html>
