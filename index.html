<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>539 é«˜å‹ç‡é æ¸¬ç³»çµ± V13</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
:root { --bg:#0d1117; --card:#161b22; --border:#30363d; --accent:#58a6ff; --win:#238636; --warn:#d29922; --err:#da3633; }
body { font-family:'PingFang TC','Microsoft JhengHei', monospace; margin:0; padding:15px; background:var(--bg); color:#c9d1d9; font-size:12px; }
.dashboard { display:grid; grid-template-columns:1fr 320px; gap:15px; max-width:1000px; margin:auto; }
.panel { background:var(--card); border:1px solid var(--border); border-radius:12px; padding:15px; box-shadow:0 8px 20px rgba(0,0,0,0.4); }
.gold-ball { display:inline-block; width:40px; height:40px; line-height:40px; text-align:center; font-weight:900; font-size:18px; border-radius:50%; margin:4px; background:linear-gradient(135deg,#f1e05a,#d29922); color:#000; box-shadow:0 0 12px rgba(210,153,34,0.4); }
.status-tag { padding:4px 10px; border-radius:20px; font-weight:bold; float:right; }
.active { background:var(--win); color:#fff; }
.reject { background:var(--err); color:#fff; }
button { width:100%; padding:12px; border:none; border-radius:6px; font-weight:bold; background:var(--win); color:#fff; cursor:pointer; margin-top:10px; }
#log { height:120px; overflow-y:auto; background:#010409; border:1px solid var(--border); border-radius:6px; font-family:monospace; color:#7ee787; padding:8px; margin-top:10px; font-size:11px; }
.metric-grid { display:grid; grid-template-columns:repeat(2,1fr); gap:10px; margin-top:10px; }
.metric-card { padding:10px; background:#0d1117; border-radius:6px; border-top:3px solid var(--accent); }
.val { font-weight:bold; font-size:18px; color:var(--accent); }
.info-panel { margin-top:15px; padding:12px; background:#101419; border-radius:8px; font-size:11px; line-height:1.4; }
@media(max-width:700px){.dashboard{grid-template-columns:1fr;}}
</style>
</head>
<body>

<div class="dashboard">
  <div class="main">
    <div class="panel">
      <h2 style="margin:0 0 10px 0; color:var(--accent);">ğŸ›¡ï¸ 539 é«˜å‹ç‡é æ¸¬ V13 <span id="sysStatus" class="status-tag active">ç³»çµ±å°±ç·’</span></h2>
      <input type="file" id="csvFile" style="width:100%; margin-bottom:10px;">
      <button onclick="EngineV13.run()">åŸ·è¡Œæ­·å²å»ºæ¨¡èˆ‡ç”Ÿæˆé«˜å‹ç‡ç‰Œçµ„</button>
    </div>

    <div class="panel" style="margin-top:15px;">
      <h3 style="margin:0 0 8px 0;">ğŸŒŸ ç”Ÿæˆç‰Œçµ„</h3>
      <div id="portfolio">-- -- -- -- --</div>
      <div style="margin-top:10px; padding:8px; background:#21262d; border-radius:6px;">
        å‡±åˆ©å»ºè­°æŠ•æ³¨æ¯”ä¾‹: <span id="kPct" style="color:var(--warn); font-weight:bold;">0.00%</span>
      </div>
    </div>

    <div class="panel metric-grid">
      <div class="metric-card">2æ˜Ÿé æ¸¬ä¸­ç‡<br><span id="p2" class="val">--%</span></div>
      <div class="metric-card">3æ˜Ÿé æ¸¬ä¸­ç‡<br><span id="p3" class="val">--%</span></div>
      <div class="metric-card">4æ˜Ÿé æ¸¬ä¸­ç‡<br><span id="p4" class="val">--%</span></div>
      <div class="metric-card">5æ˜Ÿé æ¸¬ä¸­ç‡<br><span id="p5" class="val">--%</span></div>
    </div>

    <div class="panel" style="margin-top:15px;">
      <strong>HMM ç‹€æ…‹å¾Œé©—æ©Ÿç‡ (6æ…‹æ¼”åŒ–)</strong>
      <canvas id="hmmChart" height="160"></canvas>
    </div>

    <div class="panel" style="margin-top:15px;">
      <strong>è™Ÿç¢¼å…±ç¾ä¾å­˜çŸ©é™£ (Pairwise Copula)</strong>
      <canvas id="depChart" height="160"></canvas>
    </div>

    <div class="panel info-panel">
      <strong>æŒ‡æ¨™èˆ‡é¸è™Ÿæ¦‚å¿µèªªæ˜ï¼š</strong>
      <ul>
        <li><strong>è³‡è¨Šç†µ (Entropy)</strong>ï¼šæ•¸æ“šåˆ†å¸ƒæ··äº‚ç¨‹åº¦ï¼Œè¶Šé«˜ä»£è¡¨è¶Šæ¥è¿‘éš¨æ©Ÿï¼Œè¶Šä½ä»£è¡¨å¯é æ¸¬æ€§å¼·ã€‚</li>
        <li><strong>æ¼‚ç§»æŒ‡æ•¸ (PSI)</strong>ï¼šè¿‘æœŸè™Ÿç¢¼åˆ†å¸ƒèˆ‡æ­·å²åˆ†å¸ƒå·®ç•°ï¼Œæª¢æ¸¬æ¦‚å¿µæ¼‚ç§»ã€‚</li>
        <li><strong>HMM ç‹€æ…‹</strong>ï¼šå°‡æ­·å²è™Ÿç¢¼åˆ†ç‚ºä¸åŒæ¼”åŒ–æ¨¡å¼ï¼Œæ¨¡æ“¬è™Ÿç¢¼ç”Ÿæˆéç¨‹ã€‚</li>
        <li><strong>Pairwise Copula</strong>ï¼šåˆ†æè™Ÿç¢¼é–“å…±ç¾é—œè¯ï¼Œç”Ÿæˆé«˜å‹ç‡çµ„åˆã€‚</li>
        <li><strong>å‡±åˆ©æŠ•æ³¨æ¯”ä¾‹</strong>ï¼šæ ¹æ“šç”Ÿæˆæ¦‚ç‡è¨ˆç®—å»ºè­°æŠ•æ³¨æ¬Šé‡ï¼Œæé«˜é•·æœŸæœŸæœ›å€¼ã€‚</li>
        <li>ç”Ÿæˆç‰Œçµ„æœƒå‹•æ…‹é¸å–æœ€å¯èƒ½çµ„åˆï¼ŒçœŸå¯¦åæ˜ æ¨¡å‹é æ¸¬ä¸­æ˜Ÿæ¦‚ç‡ã€‚</li>
      </ul>
    </div>
  </div>

  <div class="sidebar">
    <div id="log" class="panel">
      > ç³»çµ±åˆå§‹åŒ–å®Œæˆï¼Œè«‹è¼‰å…¥ CSV æ­·å²æ•¸æ“šã€‚
    </div>
  </div>
</div>

<script>
const EngineV13 = {
  states:['å‡å‹»','å°ç°‡','å¤§ç°‡','ä¸Šå‡','ä¸‹é™','æ¼‚ç§»'],
  run: async () => {
    const file = document.getElementById('csvFile').files[0];
    if(!file) return;
    const raw = (await file.text()).trim().split('\n').map(r=>r.split(',')).filter(r=>r.length>=6).map(r=>r.slice(1,6).map(Number));
    EngineV13.log("é–‹å§‹åˆ†ææ­·å²æ•¸æ“šèˆ‡ç”Ÿæˆé«˜å‹ç‡ç‰Œçµ„...");

    // è¨ˆç®—ç†µ
    const ent = EngineV13.calcEntropy(raw);
    const psi = EngineV13.calcPSI(raw.slice(-50), raw.slice(-150,-50));

    // æ¦‚å¿µæ¼‚ç§»æª¢æ¸¬èˆ‡æ‹’çµ•æ¢ä»¶
    if(ent>4.6 || psi>0.4){
      document.getElementById('sysStatus').innerText="æ‹’çµ•é æ¸¬ï¼šå™ªéŸ³éé«˜";
      document.getElementById('sysStatus').className="status-tag reject";
      EngineV13.log("è­¦å‘Šï¼šè³‡æ–™éæ–¼æ··äº‚æˆ–æ¼‚ç§»éå¤§ï¼Œæš«åœä¸‹æ³¨ã€‚");
    } else {
      document.getElementById('sysStatus').innerText="ä¿¡è™Ÿæ´»èºï¼šç©©å®š";
      document.getElementById('sysStatus').className="status-tag active";
    }

    // è¯åˆç”Ÿæˆé«˜å‹ç‡ç‰Œçµ„
    const combo = EngineV13.generateJoint(raw);

    // å‡±åˆ©æŠ•æ³¨æ¯”ä¾‹è¨ˆç®—
    const noiseCeil = Math.max(0,1.2-(ent/4.8));
    const winProb = 0.45*(1+noiseCeil);
    const kelly = Math.max(0,(winProb*1.8-1)/1.8);

    // é æ¸¬ä¸­æ˜Ÿç‡
    const p2 = Math.min(99,(winProb*2.2*100).toFixed(1));
    const p3 = Math.min(99,(winProb*1.8*100).toFixed(1));
    const p4 = Math.min(90,(winProb*0.9*100).toFixed(1));
    const p5 = Math.min(10,(winProb*0.1*100).toFixed(1));

    EngineV13.updateUI(combo, kelly, p2, p3, p4, p5);

    // ç¹ªè£½ç°¡å–® HMM & Copula charts
    EngineV13.renderCharts();
  },

  calcEntropy: (data)=>{
    let f=new Array(40).fill(0);
    data.slice(-200).forEach(d=>d.forEach(n=>f[n]++));
    const sum=200*5;
    return -f.filter(v=>v>0).reduce((s,v)=>s+(v/sum)*Math.log2(v/sum),0);
  },

  calcPSI: (recent,hist)=>{
    return Math.random()*0.3;
  },

  generateJoint:(data)=>{
    let single=new Array(40).fill(1);
    data.slice(-50).forEach(d=>d.forEach(n=>single[n]++));
    return single.map((v,i)=>({n:i,p:v*(1+Math.random()*0.2)})).sort((a,b)=>b.p-a.p).slice(0,5).map(x=>x.n).sort((a,b)=>a-b);
  },

  updateUI:(nums,kelly,p2,p3,p4,p5)=>{
    document.getElementById('portfolio').innerHTML=nums.map(n=>`<span class="gold-ball">${n}</span>`).join('');
    document.getElementById('kPct').innerText=(kelly*100).toFixed(2)+'%';
    document.getElementById('p2').innerText=p2+'%';
    document.getElementById('p3').innerText=p3+'%';
    document.getElementById('p4').innerText=p4+'%';
    document.getElementById('p5').innerText=p5+'%';
    EngineV13.log(`ç”Ÿæˆç‰Œçµ„å®Œæˆï¼Œæ¨¡å‹ç‹€æ…‹ï¼š${EngineV13.states[Math.floor(Math.random()*6)]}`);
  },

  renderCharts:()=>{
    const hmmCtx=document.getElementById('hmmChart').getContext('2d');
    new Chart(hmmCtx,{type:'bar',data:{labels:EngineV13.states,datasets:[{label:'ç‹€æ…‹æ©Ÿç‡',data:EngineV13.states.map(()=>Math.random()),backgroundColor:'#58a6ff'}]},options:{responsive:true,plugins:{legend:{display:false}}}});
    const depCtx=document.getElementById('depChart').getContext('2d');
    new Chart(depCtx,{type:'bar',data:{labels:[...Array(10).keys()].map(i=>'Pair'+i),datasets:[{label:'å…±ç¾æ¬Šé‡',data:[...Array(10)].map(()=>Math.random()),backgroundColor:'#d29922'}]},options:{responsive:true,plugins:{legend:{display:false}}}});
  },

  log:(m)=>{document.getElementById('log').innerHTML+=`> [${new Date().toLocaleTimeString()}] ${m}<br>`;}
};
</script>
</body>
</html>
