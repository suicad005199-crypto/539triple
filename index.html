<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI 逐期回測系統 - 命中標色版</title>
    <style>
        :root {
            --ios-blue: #007AFF;
            --ios-bg: #F2F2F7;
            --ios-card: #FFFFFF;
            --hit-red: #FF3B30;
            --predict-gold: #FFF9E6;
        }

        body {
            font-family: -apple-system, system-ui, sans-serif;
            background: var(--ios-bg);
            margin: 0;
            padding: 15px 15px 50px;
        }

        .panel {
            background: var(--ios-card);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .panel-title {
            font-size: 13px;
            font-weight: 600;
            color: #8E8E93;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
        }

        .auto-scroll { max-height: 350px; overflow-y: auto; scroll-behavior: smooth; }

        table { border-collapse: collapse; width: 100%; font-size: 12px; }
        th, td { border-bottom: 0.5px solid #E5E5EA; padding: 10px 4px; text-align: center; }
        th { position: sticky; top: 0; background: #F8F8F8; z-index: 10; }

        /* 預測列與命中標色 */
        .predict-row { background: var(--predict-gold); font-weight: bold; }
        
        /* 預測號碼球樣式 */
        .num-ball {
            display: inline-block;
            width: 22px;
            height: 22px;
            line-height: 22px;
            text-align: center;
            margin: 0 1px;
            border-radius: 50%;
        }
        
        /* 命中時的樣式 */
        .is-hit {
            background-color: var(--hit-red);
            color: white;
            font-weight: bold;
        }

        .hit-count-cell { color: var(--hit-red); font-weight: bold; font-size: 14px; }
        .num-cell { min-width: 22px; color: #C7C7CC; font-size: 10px; }
        .grid-hit { background: #FFCC00; color: #000; border-radius: 4px; font-weight: bold; }
        #bestNumbers { font-size: 26px; color: var(--hit-red); font-weight: bold; text-align: center; }
    </style>
</head>
<body>

    <div class="panel">
        <span class="panel-title">PANEL 1: 數據導入</span>
        <input type="file" id="csvFile" accept=".csv" style="width:100%">
    </div>

    <div class="panel">
        <span class="panel-title">PANEL 2: 下期精準預測</span>
        <div id="bestNumbers">等待數據...</div>
    </div>

    <div class="panel">
        <span class="panel-title">PANEL 3: 歷史逐期預測回測 <span style="color:var(--ios-blue)">● 命中自動標色</span></span>
        <div class="auto-scroll" id="p3Scroll">
            <table>
                <thead>
                    <tr>
                        <th>日期</th>
                        <th>開獎號碼</th>
                        <th>當期預測 (命中標紅)</th>
                        <th>命中</th>
                    </tr>
                </thead>
                <tbody id="p3Body"></tbody>
            </table>
        </div>
    </div>

    <div class="panel">
        <span class="panel-title">PANEL 4: 分佈圖表 (1-39)</span>
        <div style="overflow-x:auto">
            <table>
                <thead><tr id="distHeader"><th>日期</th></tr></thead>
                <tbody id="p4Body"></tbody>
            </table>
        </div>
    </div>

    <script>
        // 初始化 Panel 4 標題
        const distHeader = document.getElementById('distHeader');
        for (let i = 1; i <= 39; i++) {
            let th = document.createElement('th');
            th.innerText = i; th.className = 'num-cell';
            distHeader.appendChild(th);
        }

        // 模擬策略
        function strategyGenerator() {
            let res = [];
            while(res.length < 8) {
                let r = Math.floor(Math.random() * 39) + 1;
                let s = r.toString().padStart(2, '0');
                if(!res.includes(s)) res.push(s);
            }
            return res.sort();
        }

        document.getElementById('csvFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = (ev) => processData(ev.target.result);
            reader.readAsText(file);
        });

        function processData(csv) {
            let rows = csv.trim().split(/\r?\n/)
                .map(l => l.split(',').map(c => c.trim().replace(/"/g, '')))
                .filter(c => !isNaN(Date.parse(c[0])) && !c[0].includes("日期"));

            if (rows.length === 0) return;

            const dates = rows.map(r => new Date(r[0]));
            const maxD = new Date(Math.max.apply(null, dates));
            let nextD = new Date(maxD);
            nextD.setDate(nextD.getDate() + 1);
            
            const latestPred = strategyGenerator();
            document.getElementById('bestNumbers').innerText = latestPred.join(' ');

            rows.sort((a, b) => new Date(b[0]) - new Date(a[0]));

            let p3h = "";
            let p4h = "";

            // 預測首列
            p3h += `<tr class="predict-row">
                <td>${nextD.toISOString().split('T')[0]}</td>
                <td>待開獎</td>
                <td>${latestPred.map(n => `<span class="num-ball">${n}</span>`).join('')}</td>
                <td>-</td>
            </tr>`;

            // 歷史逐期比對
            rows.forEach(r => {
                const date = r[0];
                const drawNums = r.slice(1).map(n => n.padStart(2, '0'));
                const historyPred = strategyGenerator();
                
                // 計算命中並渲染帶有標色的號碼球
                let hitCount = 0;
                let predHtml = historyPred.map(n => {
                    const hit = drawNums.includes(n);
                    if(hit) hitCount++;
                    return `<span class="num-ball ${hit ? 'is-hit' : ''}">${n}</span>`;
                }).join('');

                p3h += `<tr>
                    <td>${date}</td>
                    <td>${drawNums.join(' ')}</td>
                    <td>${predHtml}</td>
                    <td class="hit-count-cell">${hitCount}</td>
                </tr>`;

                let cells = "";
                for(let i=1; i<=39; i++) {
                    let cur = i.toString().padStart(2, '0');
                    let isHit = drawNums.includes(cur);
                    cells += `<td class="num-cell ${isHit ? 'grid-hit' : ''}">${isHit ? i : ''}</td>`;
                }
                p4h += `<tr><td>${date}</td>${cells}</tr>`;
            });

            document.getElementById('p3Body').innerHTML = p3h;
            document.getElementById('p4Body').innerHTML = p4h;
            startAutoScroll();
        }

        let scrollInterval;
        function startAutoScroll() {
            const container = document.getElementById('p3Scroll');
            if (scrollInterval) clearInterval(scrollInterval);
            scrollInterval = setInterval(() => {
                if (container.scrollTop + container.clientHeight >= container.scrollHeight) {
                    container.scrollTop = 0;
                } else {
                    container.scrollTop += 0.8;
                }
            }, 30);
        }
    </script>
</body>
</html>
