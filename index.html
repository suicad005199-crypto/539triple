<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>539 ç­–ç•¥å›æ¸¬èˆ‡é æ¸¬ï¼ˆæ•´åˆç©©å®šç‰ˆï¼‰</title>
<style>
body { font-family: Arial; padding: 20px; }
table { border-collapse: collapse; margin-top: 10px; }
td, th { border: 1px solid #ccc; padding: 4px 6px; text-align: center; }
.hit2 { background: #d0f0d0; }
.hit3 { background: #90e090; font-weight: bold; }
.warn { color: red; font-weight: bold; }
</style>
</head>
<body>

<h2>539 å›æ¸¬ / ç­–ç•¥æ¨¡æ“¬ç³»çµ±ï¼ˆç©©å®šæ•´åˆç‰ˆï¼‰</h2>

<input type="file" id="csvFile" accept=".csv">
<button onclick="run()">åŸ·è¡Œå›æ¸¬</button>

<div id="summary"></div>
<div id="warn"></div>
<div id="next"></div>
<div id="log"></div>

<script>
function parseCSV(text) {
  return text.trim().split('\n').slice(1).map(l => {
    const p = l.split(',');
    return { date: p[0], nums: p.slice(1).map(Number) };
  });
}

function run() {
  const f = document.getElementById('csvFile').files[0];
  if (!f) return alert('è«‹ä¸Šå‚³ CSV');

  const r = new FileReader();
  r.onload = e => simulate(parseCSV(e.target.result));
  r.readAsText(f);
}

function buildPool(data, i) {
  const hist = data.slice(i - 10, i);

  const freq = {};
  hist.forEach(d => d.nums.forEach(n => freq[n] = (freq[n] || 0) + 1));
  const hot = Object.keys(freq).filter(n => freq[n] >= 2).map(Number);

  const lastSeen = {};
  data.slice(0, i).forEach((d, idx) => d.nums.forEach(n => lastSeen[n] = idx));
  const cold = Object.keys(lastSeen)
    .filter(n => i - lastSeen[n] >= 10)
    .map(Number);

  let pool = [...new Set([...hot, ...cold])].filter(n => n >= 1 && n <= 39);

  for (let n = 1; pool.length < 20 && n <= 39; n++) {
    if (!pool.includes(n)) pool.push(n);
  }
  return pool;
}

function generatePicks(pool, count = 10) {
  let picks = [];
  let idx = 0;

  while (picks.length < count) {
    let c = [];
    for (let k = 0; k < pool.length && c.length < 5; k++) {
      const n = pool[(idx + k * 3) % pool.length];
      if (!c.includes(n)) c.push(n);
    }
    idx++;

    const odd = c.filter(n => n % 2).length;
    const sum = c.reduce((a,b)=>a+b,0);

    if ((odd === 2 || odd === 3) && sum >= 70 && sum <= 115) {
      const key = c.slice().sort((a,b)=>a-b).join(',');
      if (!picks.some(p => p.join(',') === key))
        picks.push(c.sort((a,b)=>a-b));
    }
  }
  return picks;
}

function simulate(data) {
  let hit2 = 0, hit3 = 0, hit4 = 0;
  let no3 = 0;
  let rows = '';

  for (let i = 10; i < data.length; i++) {
    const target = data[i].nums;
    const pool = buildPool(data, i);
    const picks = generatePicks(pool, 10);

    let best = 0;
    picks.forEach(p => {
      const h = p.filter(n => target.includes(n)).length;
      best = Math.max(best, h);
    });

    if (best >= 2) hit2++;
    if (best >= 3) hit3++;
    if (best >= 4) hit4++;
    if (best < 3) no3++; else no3 = 0;

    rows += `<tr class="${best>=3?'hit3':best>=2?'hit2':''}">
      <td>${data[i].date}</td>
      <td>${best}</td>
      <td>${picks.map(p=>'['+p.join(' ')+']').join('<br>')}</td>
    </tr>`;
  }

  const total = data.length - 10;

  document.getElementById('summary').innerHTML = `
    <h3>å›æ¸¬çµæœ</h3>
    å¯å›æ¸¬æœŸæ•¸ï¼š${total}<br>
    å‡ºæ‰‹æœŸæ•¸ï¼š${total}<br>
    â‰¥2ï¼š${(hit2/total*100).toFixed(1)}%<br>
    â‰¥3ï¼š${(hit3/total*100).toFixed(1)}%<br>
    â‰¥4ï¼š${(hit4/total*100).toFixed(1)}%
  `;

  document.getElementById('warn').innerHTML =
    no3 >= 20 ? `<div class="warn">âš  å·²é€£çºŒ ${no3} æœŸæœªå‡º â‰¥3ï¼Œå»ºè­°åœæ‰‹</div>` : '';

  document.getElementById('log').innerHTML =
    `<table>
      <tr><th>æ—¥æœŸ</th><th>æœ€ä½³å‘½ä¸­</th><th>å‡ºæ‰‹ 10 çµ„</th></tr>
      ${rows}
    </table>`;

  predictNext(data);
}

function predictNext(data) {
  const pool = buildPool(data, data.length);
  const result = generatePicks(pool, 10);

  document.getElementById('next').innerHTML = `
    <h3>ğŸ“Œ ä¸‹æœŸæ¨¡æ“¬é æ¸¬ï¼ˆå›ºå®š 10 çµ„ï¼‰</h3>
    ${result.map((p,i)=>`çµ„${i+1}ï¼š[${p.join(' ')}]`).join('<br>')}
  `;
}
</script>

</body>
</html>
